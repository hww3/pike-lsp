---
phase: 04-analysis-and-entry-point
plan: 05
type: execute
wave: 3
depends_on: [04-04]
files_modified:
  - pike-scripts/analyzer.pike
autonomous: true

must_haves:
  truths:
    - "Old handler functions removed from analyzer.pike"
    - "Old handler helper functions removed from analyzer.pike"
    - "Global cache variables removed (now in Context)"
    - "handle_request only delegates to dispatch()"
    - "main() creates Context and passes to handle_request()"
    - "analyzer.pike is now ~200 lines (down from ~3200)"
  artifacts:
    - path: "pike-scripts/analyzer.pike"
      provides: "Lightweight JSON-RPC router entry point"
      min_lines: 100
      max_lines: 300
      contains: "int main"
      contains: "protected mapping dispatch"
  key_links:
    - from: "main()"
      to: "Context"
      via: "Context instantiation and initialization"
      pattern: "Context ctx"
    - from: "main()"
      to: "handle_request()"
      via: "Context parameter passed through"
      pattern: "handle_request.*ctx"
---

<objective>
Remove all old handler functions and dead code from analyzer.pike, completing the refactoring to a clean router. This plan removes ~3000 lines of extracted code, leaving only the routing layer and JSON-RPC I/O loop.

Purpose: Clean up analyzer.pike after successful handler extraction in plans 01-04. Remove all handler functions that have been moved to Parser, Intelligence, and Analysis modules. Remove global cache variables that are now in Context. Remove helper functions that moved with their handlers.

Output: Clean analyzer.pike containing only: module path setup, Context class, HANDLERS constant, dispatch() function, handle_request() function, and main() loop.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-analysis-and-entry-point/04-CONTEXT.md
@.planning/phases/04-analysis-and-entry-point/04-RESEARCH.md
@.planning/phases/04-analysis-and-entry-point/04-04-SUMMARY.md
@.planning/phases/02-parser-module/02-01-SUMMARY.md
@.planning/phases/03-intelligence-module**---extract-introspection-and-resolution-handlers/03-04-SUMMARY.md
@.planning/phases/04-analysis-and-entry-point/04-01-SUMMARY.md
@.planning/phases/04-analysis-and-entry-point/04-02-SUMMARY.md
@.planning/phases/04-analysis-and-entry-point/04-03-SUMMARY.md
@pike-scripts/analyzer.pike
</context>

<tasks>

<task type="auto">
  <name>Remove old handler functions from analyzer.pike</name>
  <files>pike-scripts/analyzer.pike</files>
  <action>
    Remove the following handler functions from analyzer.pike (they're now in modules):

    Parser handlers (moved to Parser.pike in Phase 2):
    - handle_parse() - now: ctx->parser->parse_request()
    - handle_tokenize() - now: ctx->parser->tokenize_request()
    - handle_compile() - now: ctx->parser->compile_request()
    - handle_batch_parse() - now: ctx->parser->batch_parse_request()

    Intelligence handlers (moved to Intelligence.pike in Phase 3):
    - handle_introspect() - now: ctx->intelligence->handle_introspect()
    - handle_resolve() - now: ctx->intelligence->handle_resolve()
    - handle_resolve_stdlib() - now: ctx->intelligence->handle_resolve_stdlib()
    - handle_get_inherited() - now: ctx->intelligence->handle_get_inherited()

    Analysis handlers (moved to Analysis.pike in plans 01-03):
    - handle_find_occurrences() - now: ctx->analysis->handle_find_occurrences()
    - handle_analyze_uninitialized() - now: ctx->analysis->handle_analyze_uninitialized()
    - handle_get_completion_context() - now: ctx->analysis->handle_get_completion_context()

    Also remove the old switch statement in handle_request() - it's now replaced by the dispatch table.

    Keep handle_set_debug() logic (it's inline in HANDLERS, not a separate function).

    DO NOT remove yet: introspect_program(), evict_lru_*(), get_char_position(), analyze_*() helpers, scope analysis helpers - we'll verify what's still used in next task.
  </action>
  <verify>wc -l pike-scripts/analyzer.pike && grep -c "protected mapping handle_" pike-scripts/analyzer.pike</verify>
  <done>analyzer.pike significantly smaller; handler functions removed</done>
</task>

<task type="auto">
  <name>Remove handler helper functions from analyzer.pike</name>
  <files>pike-scripts/analyzer.pike</files>
  <action>
    Remove helper functions that are now in their respective modules:

    Parser helpers (moved to Parser.pike):
    - extract_autodoc_comments() - if exists
    - get_symbol_kind() - if exists
    - symbol_to_json() - if exists

    Intelligence helpers (moved to Intelligence.pike):
    - introspect_program() - now in Intelligence.pike
    - get_module_path() - now in Intelligence.pike

    Analysis helpers (moved to Analysis.pike):
    - get_char_position() - now protected method in Analysis.pike
    - analyze_uninitialized_impl() - now in Analysis.pike
    - analyze_scope() - now in Analysis.pike
    - analyze_function_body() - now in Analysis.pike
    - is_type_keyword() - now in Analysis.pike
    - is_identifier() - now in Analysis.pike
    - is_assignment_operator() - now in Analysis.pike
    - try_parse_declaration() - now in Analysis.pike
    - is_function_definition() - now in Analysis.pike
    - is_lambda_definition() - now in Analysis.pike
    - extract_function_params() - now in Analysis.pike
    - find_next_token() - now in Analysis.pike
    - find_next_meaningful_token() - now in Analysis.pike
    - find_prev_meaningful_token() - now in Analysis.pike
    - find_matching_brace() - now in Analysis.pike
    - find_matching_paren() - now in Analysis.pike
    - get_char_pos_in_line() - now in Analysis.pike
    - remove_out_of_scope_vars() - now in Analysis.pike
    - save_variable_states() - now in Analysis.pike
    - restore_variable_states() - now in Analysis.pike

    Cache eviction helpers:
    - evict_lru_programs() - LRU is now in LSP.Cache
    - evict_lru_stdlib() - LRU is now in LSP.Cache

    Global cache variables (remove):
    - program_cache mapping - now in Context->program_cache
    - stdlib_cache mapping - now in Context->stdlib_cache
    - cache_access_time mapping - now managed by LSP.Cache
    - max_cached_programs constant - now managed by LSP.Cache
    - max_stdlib_modules constant - now managed by LSP.Cache

    Keep for now:
    - debug() function - used by main()
    - reverse() function - check if still used anywhere
  </action>
  <verify>wc -l pike-scripts/analyzer.pike</verify>
  <done>Helper functions removed; analyzer.pike should be ~200 lines</done>
</task>

<task type="auto">
  <name>Update main() to use Context and clean up handle_request</name>
  <files>pike-scripts/analyzer.pike</files>
  <action>
    Update main() function to:
    1. Add module path at start (keep existing)
    2. Create Context instance at startup
    3. Pass Context to handle_request() calls
    4. Remove --test and --tokenize-test modes (if still there - handled by modules now)

    Updated main() structure:
    ```pike
    int main(int argc, array(string) argv) {
        // Add module path for LSP.pmod access
        master()->add_module_path("pike-scripts");

        // Initialize Context (creates all module instances)
        Context ctx = Context();

        // JSON-RPC I/O loop
        string request_data = Stdio.stdin->read();
        if (sizeof(request_data) > 0) {
            mapping request = Standards.JSON.decode(request_data);
            mapping response = handle_request(request, ctx);

            // Add JSON-RPC envelope if not present
            if (!response->jsonrpc) {
                response->jsonrpc = "2.0";
            }
            if (request->id && !response->id) {
                response->id = request->id;
            }

            write("%s", Standards.JSON.encode(response));
        }

        return 0;
    }
    ```

    Remove from handle_request():
    - The old switch statement (now using dispatch table)
    - Any direct handler calls (all go through dispatch now)

    handle_request() should now be:
    ```pike
    protected mapping handle_request(mapping request, Context ctx) {
        string method = request->method || "";
        mapping params = request->params || ([]);
        return dispatch(method, params, ctx);
    }
    ```
  </action>
  <verify>grep -n "Context ctx" pike-scripts/analyzer.pike && grep -n "switch (method)" pike-scripts/analyzer.pike</verify>
  <done>main() creates Context and passes to handle_request(); old switch statement removed</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Check analyzer.pike line count - should be ~200 lines (down from ~3200)
2. Verify no handler functions remain (grep "protected mapping handle_")
3. Verify no helper functions remain (grep "protected.*function\|protected.*int" for analysis helpers)
4. Verify no global cache variables (grep "mapping.*_cache")
5. Run pike -c pike-scripts/analyzer.pike to verify syntax
6. Test JSON-RPC request to ensure routing works
</verification>

<success_criteria>
1. analyzer.pike is 150-250 lines (was ~3200)
2. No handler functions (handle_parse, handle_introspect, etc.)
3. No helper functions (get_char_position, analyze_scope, etc.)
4. No global cache variables
5. Context class with module instances
6. HANDLERS dispatch table constant
7. dispatch() function for routing
8. handle_request() delegates to dispatch()
9. main() creates Context and passes to handle_request()
10. File compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-analysis-and-entry-point/04-05-SUMMARY.md`
</output>
