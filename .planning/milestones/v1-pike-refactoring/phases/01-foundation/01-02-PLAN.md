---
phase: 01-foundation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - LSP.pmod/Compat.pmod
autonomous: true

must_haves:
  truths:
    - "LSP.Compat.pike_version() returns detected Pike version"
    - "LSP.Compat.PIKE_VERSION constant contains version number"
    - "LSP.Compat.trim_whites('  test  ') returns 'test' on all Pike versions"
    - "Compat module detects Pike 7.6, 7.8, and 8.0.x correctly"
  artifacts:
    - path: "LSP.pmod/Compat.pmod"
      provides: "Version compatibility layer with feature detection"
      min_lines: 40
      exports: ["pike_version", "PIKE_VERSION", "PIKE_VERSION_STRING", "trim_whites"]
  key_links:
    - from: "Compat.pmod"
      to: "Pike __REAL_VERSION__ constant"
      via: "compile-time version detection"
      pattern: "__REAL_VERSION__"
---

<objective>
Create Compat.pmod with version detection, feature detection using #if constant(), and String.trim_whites() polyfill for Pike 7.6/7.8 compatibility.

Purpose: Compat.pmod provides a unified API across Pike versions 7.6, 7.8, and 8.0.x. It detects the running Pike version at compile time and provides polyfills for missing functions (like String.trim_whites in older versions). This ensures the LSP can run on all target Pike versions without conditional code scattered throughout the codebase.

Output: Loadable LSP.pmod/Compat.pmod with pike_version() function, version constants (PIKE_VERSION, PIKE_VERSION_STRING), and trim_whites() polyfill that works on all target versions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/01-foundation/01-CONTEXT.md
@.planning/codebase/CONVENTIONS.md
</context>

<tasks>

<task type="auto">
  <name>Create Compat.pmod with version detection and polyfills</name>
  <files>LSP.pmod/Compat.pmod</files>
  <action>
    Create LSP.pmod/Compat.pmod with the following components:

    1. **Version detection** (FND-05):
       Use `__REAL_VERSION__` constant to detect Pike version at compile time.
       ```pike
       //! Get the Pike version as an array: ({major, minor, patch})
       array(int) pike_version() {
           string version = __REAL_VERSION__;
           array parts = (version / ".") + ({});
           return Array.map(parts[..2], int);
       }

       constant PIKE_VERSION = __REAL_VERSION__;
       constant PIKE_VERSION_STRING = __REAL_VERSION__;
       ```

    2. **Feature detection** (FND-06):
       Use `#if constant()` to detect if String.trim_whites exists:
       ```pike
       #if constant(String.trim_whites)
       constant has_trim_whites = 1;
       #else
       constant has_trim_whites = 0;
       #endif
       ```

    3. **String.trim_whites() polyfill** (FND-07):
       Provide trim_whites function that works on Pike 7.6/7.8 where it doesn't exist natively:
       ```pike
       #if constant(String.trim_whites)
       // Use native implementation on Pike 8.x
       string trim_whites(string s) {
           return String.trim_whites(s);
       }
       #else
       // Polyfill for Pike 7.6/7.8
       string trim_whites(string s) {
           // Trim leading whitespace
           while (sizeof(s) > 0 && (<s[0] == ' ' || <s[0] == '\t' ||
                                    <s[0] == '\n' || <s[0] == '\r')) {
               s = s[1..];
           }
           // Trim trailing whitespace
           while (sizeof(s) > 0 && (<s[-1] == ' ' || <s[-1] == '\t' ||
                                    <s[-1] == '\n' || <s[-1] == '\r')) {
               s = s[0..<2];
           }
           return s;
       }
       #endif
       ```

    Implementation notes:
    - Use `<s[0]` instead of `s[0]` for single-character comparison (Pike 7.x compatibility)
    - The polyfill handles space, tab, newline, and carriage return characters
    - Native implementation is preferred when available (Pike 8.x)
    - Export has_trim_whites constant for diagnostic purposes

    Reference CONTEXT.md for the version detection strategy and trim_whites polyfill approach.
  </action>
  <verify>pike -e 'write("%s\n", LSP.Compat.pike_version() * ".");' 2>&1</verify>
  <done>
    - LSP.Compat.pike_version() returns array with major, minor, patch
    - LSP.Compat.PIKE_VERSION contains version string
    - LSP.Compat.trim_whites("  test  ") returns "test"
    - Works on Pike 7.6, 7.8, and 8.0.x
  </done>
</task>

</tasks>

<verification>
After completing all tasks, verify the Compat module works correctly:

```bash
cd /home/smuks/OpenCode/pike-lsp/pike-scripts
pike -e 'write("Version: %s\n", LSP.Compat.pike_version() * ".");'
pike -e 'write("Trimmed: [%s]\n", LSP.Compat.trim_whites("  test  "));'
pike -e 'write("Has native: %d\n", LSP.Compat.has_trim_whites);'
```

Expected results:
- Version command outputs the detected Pike version
- Trimmed command outputs: Trimmed: [test]
- Has native shows 0 on Pike 7.6/7.8, 1 on Pike 8.x
</verification>

<success_criteria>
1. LSP.pmod/Compat.pmod file exists at /home/smuks/OpenCode/pike-lsp/pike-scripts/LSP.pmod/Compat.pmod
2. Pike interpreter can load the module without errors
3. pike_version() returns correct version array
4. PIKE_VERSION constant contains version string
5. trim_whites() correctly strips leading and trailing whitespace
6. has_trim_whites indicates native vs polyfill implementation
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
