---
phase: 01-foundation
plan: 06
type: execute
wave: 3
depends_on: [01-05]
files_modified: [test/tests/e2e-foundation-tests.pike]
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Compat.trim_whites() produces identical output to native String.trim_whites() on real Pike code"
    - "Cache.pmod stores and retrieves real compiled programs via compile_string()"
    - "Stdlib module resolution works via master()->resolv()"
    - "All E2E tests pass and report with VSCode console format"
  artifacts:
    - path: "test/tests/e2e-foundation-tests.pike"
      provides: "Complete E2E tests for Compat.pmod and Cache.pmod"
      min_lines: 300
  key_links:
    - from: "e2e-foundation-tests.pike"
      to: "Pike stdlib (discovered dynamically)"
      via: "master()->resolv() and compile_string()"
      pattern: "test_compat|test_cache"
---

<objective>
Add Compat.pmod and Cache.pmod E2E tests using real Pike stdlib modules and complete the test suite with main runner.

Purpose: Validate Compat.trim_whites() matches native behavior on real code patterns. Validate Cache.pmod works with actual compiled programs. Complete E2E test suite for Phase 1.

Output: Complete E2E test suite with Compat tests, Cache tests, and main runner - all passing with portable stdlib discovery.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation/01-CONTEXT.md
@.planning/phases/01-foundation/01-02-SUMMARY.md
@.planning/phases/01-foundation/01-03-SUMMARY.md
@.planning/phases/01-foundation/01-05-SUMMARY.md

@pike-scripts/LSP.pmod/Compat.pmod
@pike-scripts/LSP.pmod/Cache.pmod
@test/tests/e2e-foundation-tests.pike
</context>

<tasks>

<task type="auto">
  <name>Test Compat.trim_whites() against real Pike code patterns</name>
  <files>test/tests/e2e-foundation-tests.pike</files>
  <action>
Add to e2e-foundation-tests.pike - Compat.pmod E2E tests:

1. test_compat_trim_whites_real_module_strings():
   - Load real stdlib modules via master()->resolv():
     * Array, String, Math (always available)
   - Use sprintf("%O", module_object) or describe_function() to get string representations
   - Create test strings from typical Pike code patterns:
     * "  constant foo = bar;\n"
     * "\t//! Documentation comment\n"
     * "  mixed result;\n  "
   - Apply Compat.trim_whites() to each
   - Verify leading/trailing whitespace removed correctly
   - Verify code content preserved

2. test_compat_trim_whites_matches_native_behavior():
   - Create test strings from typical Pike code:
     * "  constant foo = bar;\n"
     * "\t//! Documentation comment\n"
     * "  mixed result;\n  "
   - Apply both Compat.trim_whites() AND native String.trim_whites() (on Pike 8.x)
   - Compare results - both should produce identical output
   - If on Pike 8.x, verify equivalence; if on 7.x/7.8, verify polyfill works

3. test_compat_version_detection_real_pike():
   - Call LSP.Compat.pike_version()
   - Verify version >= 7.6
   - Verify version matches runtime __REAL_VERSION__
   - Log detected version using INFO level

4. test_compat_trim_whites_unicode_and_edge_cases():
   - Test with real-world edge cases from Pike code:
     * Empty strings
     * Strings with only whitespace
     * Strings with mixed tabs and spaces (common in Pike code)
     * Strings with Unicode (UTF-8 sequences)
   - Verify no crashes or unexpected behavior
  </action>
  <verify>
Run: pike test/tests/e2e-foundation-tests.pike 2>&1 | grep "compat"
Expected: All Compat.pmod E2E tests pass
  </verify>
  <done>
Compat.trim_whites() correctly processes real Pike source code patterns, matches native behavior where available
  </done>
</task>

<task type="auto">
  <name>Test Cache.pmod with real compiled programs</name>
  <files>test/tests/e2e-foundation-tests.pike</files>
  <action>
Add to e2e-foundation-tests.pike - Cache.pmod E2E tests:

1. test_cache_real_program_compilation_and_caching():
   - Use compile_string() with simple Pike code:
     ```pike
     int add(int a, int b) { return a + b; }
     ```
   - Store in Cache.put_program() with hash key
   - Retrieve with Cache.get_program()
   - Verify retrieved program matches original
   - Verify type is program (use programp())

2. test_cache_stdlib_module_resolution():
   - Load real stdlib module: master()->resolv("Array")
   - Create symbol data mapping from module (functions, constants)
   - Store in Cache.put_stdlib()
   - Retrieve with Cache.get_stdlib()
   - Verify symbol data structure is preserved
   - Test multiple modules (Array, String, Math if available)

3. test_cache_lru_with_real_programs():
   - Compile 3-4 real Pike code snippets
   - Set cache limit to 3
   - Add all to cache
   - Access first item to make it recent
   - Add fourth item (should evict second)
   - Verify LRU eviction worked correctly
   - Verify stats track hits/misses accurately

4. test_cache_statistics_with_real_workload():
   - Clear both caches
   - Simulate realistic usage pattern:
     * Add 5 program entries
     * Mix of hits and misses
     * Add some stdlib entries
   - Verify get_stats() returns accurate counts
   - Verify program_size, stdlib_size are correct
   - Log statistics using INFO level

5. test_cache_clear_and_reuse():
   - Fill program_cache with entries
   - Call clear("program_cache")
   - Verify all entries gone (size = 0)
   - Add new entries (should work after clear)
   - Verify cache is functional after clear
  </action>
  <verify>
Run: pike test/tests/e2e-foundation-tests.pike 2>&1 | grep "cache"
Expected: All Cache.pmod E2E tests pass
  </verify>
  <done>
Cache.pmod correctly stores/retrieves real compiled programs, LRU eviction works with actual program objects
  </done>
</task>

<task type="auto">
  <name>Add main test runner and complete E2E suite</name>
  <files>test/tests/e2e-foundation-tests.pike</files>
  <action>
Complete e2e-foundation-tests.pike:

1. Add main() function that:
   - Sets up module path
   - Calls discover_stdlib_path() and logs result
   - Runs all E2E tests in order:
     * Module tests (json decode/encode, LSPError, debug)
     * Compat tests (trim_whites, version detection)
     * Cache tests (real programs, LRU, statistics)
   - Prints summary with VSCode console format:
     * Total tests run
     * Tests passed
     * Tests failed
     * List of failures if any
   - Returns exit code 0 for all pass, 1 for any failure

2. Add file header documentation:
   //! E2E Foundation Tests for LSP.pmod
   //!
   //! End-to-end tests verifying foundation components work with real data:
   //! - Real LSP protocol JSON messages
   //! - Real Pike stdlib modules (loaded dynamically)
   //! - Real compiled program objects
   //!
   //! Stdlib discovery: Uses master()->pike_module_path dynamically
   //! Override: Set PIKE_STDLIB_PATH environment variable
   //!
   //! Run with: pike test/tests/e2e-foundation-tests.pike
   //!
   //! @note Tests use dynamic stdlib discovery - portable across machines

3. Add TODO comment for future enhancement:
   // TODO: Add tests for Logging.pmod when implemented
   // TODO: Add tests for Protocol.pmod when implemented
   // TODO: Cross-version tests on Pike 7.6, 7.8, 8.0.x
  </action>
  <verify>
Run: pike test/tests/e2e-foundation-tests.pike
Expected: All tests pass, VSCode console output shows timestamps and levels
  </verify>
  <done>
Complete E2E test suite runs successfully, provides clear output for debugging in VSCode
  </done>
</task>

</tasks>

<verification>
Overall verification criteria:

1. E2E test file complete at test/tests/e2e-foundation-tests.pike
2. All tests pass when run with Pike interpreter
3. Stdlib path is discovered dynamically (portable - no hardcoded paths)
4. VSCode console format is used (timestamps, levels)
5. Tests use real data from Pike stdlib (via master()->resolv)
6. Tests cover Compat.pmod and Cache.pmod with real programs
7. Tests are portable - run successfully on any machine with Pike installed

Run: pike test/tests/e2e-foundation-tests.pike

Expected output format:
[2026-01-19T18:30:00] [INFO] Starting E2E Foundation Tests
[2026-01-19T18:30:00] [INFO] Discovered stdlib path: <dynamic path>
[2026-01-19T18:30:00] [TEST] Compat.trim_whites matches native
[2026-01-19T18:30:00] [PASS] compat_trim_whites_matches_native_behavior
[2026-01-19T18:30:00] [TEST] Cache real program caching
[2026-01-19T18:30:00] [PASS] cache_real_program_compilation_and_caching
...
[2026-01-19T18:30:01] [INFO] Results: N run, N passed, 0 failed
</verification>

<success_criteria>
1. E2E test file complete and executable
2. All tests pass against real Pike stdlib
3. VSCode console output format implemented
4. Tests verify Compat.trim_whites() works on real Pike code
5. Tests verify Cache.pmod stores real compiled programs
6. Test output is clear and debuggable
7. Tests are portable - no hardcoded paths
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-06-SUMMARY.md` with:
- Compat tests created (count and coverage)
- Cache tests created (count and coverage)
- Real stdlib modules tested (via dynamic discovery)
- Confirmation all foundation modules handle real-world inputs correctly
- Portability confirmation (tests work on any machine with Pike)
</output>
