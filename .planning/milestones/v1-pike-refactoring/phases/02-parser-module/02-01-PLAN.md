---
phase: 02-parser-module
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pike-scripts/LSP.pmod/Parser.pike
  - pike-scripts/analyzer.pike
autonomous: true

must_haves:
  truths:
    - "Parser.pike class exists with parse_request method"
    - "parse_request uses Tools.AutoDoc.PikeParser for symbol extraction"
    - "parse_request uses LSP.Compat.trim_whites() for string operations"
    - "parse_request uses LSP.MAX_* constants from module.pmod"
    - "Protected helper methods are defined (_extract_autodoc_comments, _symbol_to_json, _parse_autodoc, _get_symbol_kind, _type_to_json, _save_text_buffer, _format_group_as_text, _process_inline_markup, _replace_markup)"
    - "Parser has no cache interaction per CONTEXT.md design decision"
    - "Parser.parse_request throws exceptions; handler wrapper catches them"
  artifacts:
    - path: pike-scripts/LSP.pmod/Parser.pike
      provides: Parser class with parse_request and protected helpers
      min_lines: 1000
      contains: "class Parser", "parse_request", "LSP.Compat.trim_whites"
    - path: pike-scripts/analyzer.pike
      provides: Handler wrapper using Parser class
      contains: "handle_parse", "catch.*parser->parse_request"
  key_links:
    - from: Parser.parse_request
      to: analyzer.handle_parse
      via: exception propagation
      pattern: "throws on error"
    - from: analyzer.handle_parse
      to: Parser.parse_request
      via: delegation with catch wrapper
      pattern: "catch.*parser->parse_request"
    - from: Parser.pike
      to: LSP.Compat.trim_whites
      via: direct function call
      pattern: "LSP\\.Compat\\.trim_whites"
    - from: Parser.pike
      to: LSP.MAX_TOP_LEVEL_ITERATIONS
      via: constant reference
      pattern: "LSP\\.MAX_TOP_LEVEL_ITERATIONS"
---

<objective>
Create Parser.pike class with parse_request method and protected helpers extracted from analyzer.pike

Purpose: Extract the core parsing functionality from analyzer.pike into a reusable, stateless Parser class that uses shared infrastructure from Phase 1

Note on cache: Per CONTEXT.md, "Parser has no cache. This is critical." Cache interaction remains in analyzer.pike handler layer (the caller), not in Parser.pike. This plan correctly implements stateless Parser design.

Note on error handling: Per CONTEXT.md, "Parser accumulates errors in result structure; caller decides whether to log." Parser.parse_request throws exceptions on unexpected errors; handler wrapper (Task 3) catches them and converts to JSON-RPC error responses.

Output: Parser.pike file with parse_request method and all shared helper functions as protected methods
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
@.planning/phases/01-foundation/01-02-SUMMARY.md
@.planning/phases/02-parser-module/02-CONTEXT.md
@.planning/phases/02-parser-module/02-RESEARCH.md
@pike-scripts/analyzer.pike
@pike-scripts/LSP.pmod/module.pmod
@pike-scripts/LSP.pmod/Compat.pmod
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Parser.pike with class structure and parse_request method</name>
  <files>pike-scripts/LSP.pmod/Parser.pike</files>
  <action>
Create pike-scripts/LSP.pmod/Parser.pike with the following structure:

1. File header with AutoDoc comments describing the Parser class
2. Class declaration: `class Parser {`
3. Constructor: `void create() { }` (no arguments - stateless parser)
4. Public method `parse_request(mapping params)` extracted from analyzer.pike handle_parse (lines 85-413)

Key migrations from original handle_parse:
- Replace all `String.trim_whites(` with `LSP.Compat.trim_whites(`
- Replace `MAX_TOP_LEVEL_ITERATIONS` with `LSP.MAX_TOP_LEVEL_ITERATIONS`
- Replace `MAX_BLOCK_ITERATIONS` with `LSP.MAX_BLOCK_ITERATIONS`
- Return the same result structure: `(["result": (["symbols": symbols, "diagnostics": diagnostics])])`

Design notes per CONTEXT.md:
- DO NOT include cache interaction - Parser is stateless, cache belongs to handler layer
- DO NOT include outer catch block - Parser throws exceptions, handler catches them
- Parser is a pure function: source text in, structured result out

Keep all the preprocessing logic (lines 97-129), PikeParser usage (lines 131-386), and error accumulation (lines 389-405).

The method signature should be:
```pike
//! Parse Pike source code and extract symbols
//! @param params Mapping with "code", "filename", "line" keys
//! @returns Mapping with "result" containing "symbols" and "diagnostics"
//! @throws On unexpected parsing errors (caller catches)
mapping parse_request(mapping params)
```
  </action>
  <verify>
    pike -Mpike-scripts -e "import LSP; Parser p = Parser(); werror('%O\n', p->parse_request(([\"code\": \"int x;\", \"filename\": \"test.pike\", \"line\": 1])));"
    Should return a mapping with "result" key containing "symbols" array.
  </verify>
  <done>
    Parser.pike exists and can be instantiated
    parse_request method returns symbols from Pike source code
    Uses LSP.Compat.trim_whites() for string operations
    Uses LSP.MAX_* constants for iteration limits
    Has no cache interaction (stateless per CONTEXT.md)
    Throws exceptions on error (no outer catch block)
  </done>
</task>

<task type="auto">
  <name>Task 2: Add protected helper methods to Parser class</name>
  <files>pike-scripts/LSP.pmod/Parser.pike</files>
  <action>
Add the following protected helper methods to the Parser class, extracted from analyzer.pike:

1. `_extract_autodoc_comments(string code)` - from lines 417-450
   - Migrate: Replace `String.trim_whites(` with `LSP.Compat.trim_whites(`

2. `_symbol_to_json(object symbol, string|void documentation)` - from lines 712-783
   - Keep as-is (no String.trim_whites calls)
   - Calls _parse_autodoc and _type_to_json

3. `_parse_autodoc(string doc)` - from lines 788-1145
   - Migrate: Replace all `String.trim_whites(` with `LSP.Compat.trim_whites(`
   - Calls _save_text_buffer, _format_group_as_text, _process_inline_markup

4. `_get_symbol_kind(object symbol)` - from lines 1411-1450
   - Keep as-is (no String.trim_whites calls)

5. `_type_to_json(object|void type)` - from lines 1452-1527
   - Keep as-is (no String.trim_whites calls)

6. `_save_text_buffer(mapping result, string section, string param, array(string) buffer)` - from lines 1148-1271
   - Migrate: Replace `String.trim_whites(` with `LSP.Compat.trim_whites(`

7. `_format_group_as_text(string group_type, array(mapping) items)` - from lines 1276-1338
   - Keep as-is (no String.trim_whites calls)

8. `_process_inline_markup(string text)` - from lines 1350-1389
   - Keep as-is (no String.trim_whites calls)

9. `_replace_markup(string text, string open_tag, string close_tag, string md_open, string md_close)` - from lines 1392-1409
   - Keep as-is (no String.trim_whites calls)

All helpers should have `protected` visibility and use underscore prefix in name (e.g., `protected mapping(int:string) _extract_autodoc_comments(string code)`).

Add AutoDoc comments for each helper using //! format.
  </action>
  <verify>
    pike -Mpike-scripts -e "import LSP; Parser p = Parser(); werror('%O\n', p->_get_symbol_kind(class { }));"
    Should return "unknown" for a test class.
  </verify>
  <done>
    All 9 protected helper methods exist in Parser class
    All String.trim_whites() calls migrated to LSP.Compat.trim_whites()
    parse_request method calls helpers correctly
  </done>
</task>

<task type="auto">
  <name>Task 3: Update analyzer.pike to use Parser class for handle_parse</name>
  <files>pike-scripts/analyzer.pike</files>
  <action>
Modify analyzer.pike handle_parse function (lines 85-413):

Per CONTEXT.md: "Parser should NOT depend on LSP types... Parser accumulates errors in result structure; caller decides whether to log." This handler wrapper provides the catch block that converts Parser exceptions into JSON-RPC error responses.

Also per CONTEXT.md on cache: "Parser has no cache. This is critical." Cache interaction (if any for compiled programs) remains in analyzer.pike handler layer, not in Parser.pike.

1. At the top of analyzer.pike (after the debug function), add:
   ```pike
   // Import Parser module
   constant Parser = LSP.Parser;
   ```

2. Replace handle_parse implementation with a thin wrapper:
   - Create a Parser instance: `Parser parser = Parser();`
   - Delegate to parser->parse_request(params)
   - Wrap in catch block to return JSON-RPC error response on exception

New handle_parse should be:
```pike
protected mapping handle_parse(mapping params) {
  Parser parser = Parser();

  mixed err = catch {
    return parser->parse_request(params);
  };

  // Return JSON-RPC error on exception
  return ([
    "error": ([
      "code": -32000,
      "message": describe_error(err)
    ])
  ]);
}
```

3. Remove the old helper functions that were moved to Parser.pike:
   - extract_autodoc_comments (lines 417-450)
   - symbol_to_json (lines 712-783)
   - parse_autodoc (lines 788-1145)
   - get_symbol_kind (lines 1411-1450)
   - type_to_json (lines 1452-1527)
   - save_text_buffer (lines 1148-1271)
   - format_group_as_text (lines 1276-1338)
   - process_inline_markup (lines 1350-1389)
   - replace_markup (lines 1392-1409)

Note: The old handle_parse body (lines 97-412) is now in Parser.pike, so we can replace the entire function.
  </action>
  <verify>
    pike pike-scripts/analyzer.pike
    Then send a JSON-RPC request: {"jsonrpc":"2.0","method":"parse","params":{"code":"int x;","filename":"test.pike"},"id":1}
    Should return valid JSON with symbols array.
  </verify>
  <done>
    handle_parse delegates to Parser.parse_request with catch wrapper
    Handler wrapper converts exceptions to JSON-RPC errors
    Old helper functions removed from analyzer.pike
    Parser remains stateless with no cache interaction
  </done>
</task>

</tasks>

<verification>
1. Parser.pike file exists in pike-scripts/LSP.pmod/
2. Parser class can be instantiated: `Parser p = Parser();`
3. parse_request method returns symbols from test code
4. All 9 protected helper methods are defined
5. No String.trim_whites() calls remain in Parser.pike (all use LSP.Compat.trim_whites())
6. Parser has no cache interaction (stateless per CONTEXT.md)
7. Parser.parse_request throws exceptions (no outer catch block)
8. analyzer.pike handle_parse delegates to Parser class
9. Handler wrapper has catch block returning JSON-RPC errors
10. Old helper functions removed from analyzer.pike
11. Full end-to-end test: analyzer.pike responds to parse method with correct output
</verification>

<success_criteria>
1. Parser.pike class exists with parse_request method and 9 protected helpers
2. parse_request extracts symbols from Pike source code using Tools.AutoDoc.PikeParser
3. All string trimming uses LSP.Compat.trim_whites() for cross-version compatibility
4. Iteration limits use LSP.MAX_* constants from module.pmod
5. Parser has no cache interaction (stateless per CONTEXT.md)
6. Parser methods throw exceptions; handler wrappers catch them
7. analyzer.pike handle_parse delegates to Parser class with catch wrapper
8. Old helper functions removed from analyzer.pike
9. JSON-RPC parse method still works correctly after refactoring
10. Error handling flow: Parser throws → handler catches → returns JSON-RPC error
</success_criteria>

<output>
After completion, create `.planning/phases/02-parser-module/02-01-SUMMARY.md`
</output>
