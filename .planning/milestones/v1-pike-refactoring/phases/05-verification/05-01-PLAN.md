---
phase: 05-verification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [test/tests/module-load-tests.pike]
autonomous: true
user_setup: []

must_haves:
  truths:
    - "All LSP modules (module.pmod, Compat.pmod, Cache.pmod, Parser.pike, Intelligence.pike, Analysis.pike) load via master()->resolv()"
    - "Module loading test runs first in CI for fail-fast behavior"
    - "Each module exports at least one critical function/class"
  artifacts:
    - path: "test/tests/module-load-tests.pike"
      provides: "Module loading smoke tests"
      min_lines: 50
      exports: ["test_module_loading", "test_critical_exports"]
  key_links:
    - from: "module-load-tests.pike"
      to: "pike-scripts/LSP.pmod/*"
      via: "master()->resolv()"
      pattern: "master\\(\\)->resolv\\(\"LSP\\.[^\"]+\"\\)"
---

<objective>
Create module loading smoke tests to verify all LSP modules load correctly on the installed Pike version.

Purpose: Provide fail-fast CI verification that the refactored modular codebase can be loaded. This catches syntax errors, missing dependencies, circular imports, and compat shim failures before running slower integration tests.
Output: Module loading test file that validates all six LSP modules load and export expected symbols.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-verification/05-CONTEXT.md
@.planning/REQUIREMENTS.md

# Prior phase summaries for module structure
@.planning/phases/01-foundation/01-06-SUMMARY.md
@.planning/phases/04-analysis-and-entry-point/04-VERIFICATION.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create module loading test file</name>
  <files>test/tests/module-load-tests.pike</files>
  <action>
Create `test/tests/module-load-tests.pike` with the following structure:

1. **Test setup:**
   - Add module path setup: `add_module_path("../../../pike-scripts")` (relative to test file location)
   - Import necessary test utilities

2. **test_module_loading:**
   - Load each LSP module via master()->resolv():
     - LSP.module (for constants, LSPError)
     - LSP.Compat (for version detection, trim_whites)
     - LSP.Cache (for get/put/clear)
     - LSP.Parser (for Parser class)
     - LSP.Intelligence (for Intelligence class)
     - LSP.Analysis (for Analysis class)
   - Verify each module loads without throwing an exception
   - Report any modules that fail to load

3. **test_critical_exports:**
   - Verify each module has at least one expected export:
     - LSP.module: LSPError class, MAX_TOP_LEVEL_ITERATIONS constant
     - LSP.Compat: pike_version() function, trim_whites() function
     - LSP.Cache: get(), put(), clear() functions
     - LSP.Parser: Parser class
     - LSP.Intelligence: Intelligence class
     - LSP.Analysis: Analysis class
   - Use `functionp()` and `classp()` to verify export types

4. **test_version_logging:**
   - Call LSP.Compat.pike_version()
   - Log the detected Pike version (for CI debugging)

5. **Follow existing test patterns:**
   - Use the same test structure as `foundation-tests.pike`
   - Include werror() output for test progress
   - Return 1 for success, 0 for failure
   - Include main() entry point that runs all tests

File should be ~100-150 lines following the established test file pattern.
  </action>
  <verify>pike test/tests/module-load-tests.pike</verify>
  <done>All six LSP modules load successfully and export expected symbols. Test outputs Pike version for CI debugging.</done>
</task>

<task type="auto">
  <name>Task 2: Test module load on current Pike version</name>
  <files>test/tests/module-load-tests.pike</files>
  <action>
Run the module loading test to verify it works on the current installed Pike version.

1. Execute: `pike test/tests/module-load-tests.pike`
2. Verify all tests pass
3. Check that Pike version is logged
4. If any failures occur, fix the test file and re-run

This confirms the test works before CI integration.
  </action>
  <verify>pike test/tests/module-load-tests.pike && echo "All module load tests passed"</verify>
  <done>Module loading tests pass on the installed Pike version (developer's local version).</done>
</task>

</tasks>

<verification>
After completing all tasks:

1. Run module loading tests: `pike test/tests/module-load-tests.pike`
2. Verify all six modules load (module, Compat, Cache, Parser, Intelligence, Analysis)
3. Verify Pike version is logged to output
4. Verify test follows existing test file patterns
5. Verify file has main() entry point and proper return values
</verification>

<success_criteria>
1. `test/tests/module-load-tests.pike` exists with at least 3 test functions
2. All LSP modules load successfully via master()->resolv()
3. Each module's critical exports are verified
4. Pike version is logged for debugging
5. Test passes on the installed Pike version
</success_criteria>

<output>
After completion, create `.planning/phases/05-verification/05-01-SUMMARY.md`
</output>
