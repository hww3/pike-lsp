---
phase: 05-verification
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: [.github/workflows/test.yml]
autonomous: true
user_setup: []

must_haves:
  truths:
    - "GitHub Actions workflow runs Pike tests on multiple versions"
    - "Primary version (Pike 8.1116) must pass to merge"
    - "Latest Pike version runs with continue-on-error (best-effort)"
    - "Module loading tests run first for fail-fast behavior"
  artifacts:
    - path: ".github/workflows/test.yml"
      provides: "CI workflow with Pike version matrix"
      contains: "strategy.matrix.pike-version"
  key_links:
    - from: ".github/workflows/test.yml"
      to: "test/tests/*.pike"
      via: "pike test/tests/*.pike"
      pattern: "pike.*test/tests"
---

<objective>
Extend the GitHub Actions CI workflow to test Pike code on multiple Pike versions using a matrix strategy.

Purpose: Automated cross-version verification on every pull request and push. This ensures the refactored codebase works on the target Pike versions (8.1116 required, latest best-effort) without requiring manual testing.
Output: Updated CI workflow with Pike version matrix and Pike test execution.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-verification/05-CONTEXT.md
@.planning/REQUIREMENTS.md

# Prior CI infrastructure
@.github/workflows/test.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend GitHub Actions with Pike version matrix</name>
  <files>.github/workflows/test.yml</files>
  <action>
Modify `.github/workflows/test.yml` to add Pike version testing. The existing workflow runs Node.js tests and installs pike8.0. Extend it to:

1. **Add a new job "pike-test"** after the existing "test" job:
   - runs-on: ubuntu-24.04
   - strategy.matrix with Pike versions:
     - pike-version: ["8.1116", "latest"]
   - Add continue-on-error: true for the "latest" version (best-effort)

2. **Pike installation per version:**
   - For 8.1116: Download and install from Pike's official repository or build from source if package not available
   - For "latest": Install from Pike's repository (whatever version is current)
   - Use conditional installation based on matrix.pike-version

3. **Pike test steps:**
   - Checkout code
   - Install Pike (version-dependent)
   - Verify Pike installation (`pike --version`)
   - Run module loading tests: `pike test/tests/module-load-tests.pike` (FAIL FAST)
   - Run foundation tests: `pike test/tests/foundation-tests.pike`
   - Run parser tests: `pike test/tests/parser-tests.pike`
   - Run intelligence tests: `pike test/tests/intelligence-tests.pike`
   - Run analysis tests: `pike test/tests/analysis-tests.pike`
   - Run response format tests: `pike test/tests/response-format-tests.pike`
   - Run E2E tests: `pike test/tests/e2e-foundation-tests.pike`

4. **Matrix result visualization:**
   - Use GitHub Actions matrix display to show side-by-side results

**Note on Pike 8.1116 availability:**
Ubuntu 24.04's default is pike8.0. Pike 8.1116 is a newer version from the Pike 8.1 series. The installation may need to:
- Download from Pike's official download page (builds.pike.lysator.liu.se or similar)
- Or compile from source if prebuilt binaries unavailable

**Important:** The pike-test job should NOT depend on the Node.js test job. They can run in parallel. Only the build-extension job should depend on test jobs passing.

**Structure:**
- Keep existing "test" job (Node.js) unchanged
- Add new "pike-test" job with matrix
- build-extension job should depend on both "test" and "pike-test" (but only fail on required versions)

5. **For continue-on-error on "latest" version:**
   - Set continue-on-error: ${{ matrix.pike-version == 'latest' }}
   - This allows the matrix to complete even if latest Pike fails
   - The overall job status should still fail if 8.1116 fails

Use GitHub Actions matrix syntax:
```yaml
strategy:
  matrix:
    pike-version: ["8.1116", "latest"]
  fail-fast: false
```
  </action>
  <verify>
grep -A 20 "pike-test:" /home/smuks/OpenCode/pike-lsp/.github/workflows/test.yml | grep -E "(pike-version|strategy|matrix)"
  </verify>
  <done>GitHub Actions workflow includes pike-test job with matrix strategy for 8.1116 and latest. Module loading tests run first. Latest version has continue-on-error.</done>
</task>

<task type="auto">
  <name>Task 2: Add Pike test script runner</name>
  <files>scripts/run-pike-tests.sh</files>
  <action>
Create `scripts/run-pike-tests.sh` script that runs all Pike tests in order:

1. **Module loading tests first** (fail-fast):
   ```bash
   echo "Loading modules..."
   pike test/tests/module-load-tests.pike || exit 1
   ```

2. **Foundation tests**:
   ```bash
   pike test/tests/foundation-tests.pike || exit 1
   ```

3. **Parser tests**:
   ```bash
   pike test/tests/parser-tests.pike || exit 1
   ```

4. **Intelligence tests**:
   ```bash
   pike test/tests/intelligence-tests.pike || exit 1
   ```

5. **Analysis tests**:
   ```bash
   pike test/tests/analysis-tests.pike || exit 1
   ```

6. **Response format tests**:
   ```bash
   pike test/tests/response-format-tests.pike || exit 1
   ```

7. **E2E tests**:
   ```bash
   pike test/tests/e2e-foundation-tests.pike || exit 1
   ```

8. **Summary output**:
   - Total tests run
   - Pass/fail summary
   - Pike version detected

Make the script executable (chmod +x). The script should be usable both locally and in CI.

CI can then simply run: `./scripts/run-pike-tests.sh`
  </action>
  <verify>chmod +x /home/smuks/OpenCode/pike-lsp/scripts/run-pike-tests.sh && ./scripts/run-pike-tests.sh 2>&1 | head -20</verify>
  <done>run-pike-tests.sh script exists, is executable, and runs all Pike tests in the correct order with proper error handling.</done>
</task>

<task type="auto">
  <name>Task 3: Update CI workflow to use test script</name>
  <files>.github/workflows/test.yml</files>
  <action>
Update the pike-test job in `.github/workflows/test.yml` to use the new script:

Instead of running individual test files, use:
```yaml
- name: Run Pike Tests
  run: ./scripts/run-pike-tests.sh
```

This keeps the CI workflow cleaner and ensures consistency between local and CI test execution.
  </action>
  <verify>grep "run-pike-tests.sh" /home/smuks/OpenCode/pike-lsp/.github/workflows/test.yml</verify>
  <done>CI workflow calls run-pike-tests.sh instead of individual test commands.</done>
</task>

</tasks>

<verification>
After completing all tasks:

1. Verify `.github/workflows/test.yml` contains pike-test job with matrix strategy
2. Verify matrix includes 8.1116 and latest versions
3. Verify continue-on-error is set for latest version
4. Verify `scripts/run-pike-tests.sh` exists and is executable
5. Run tests locally: `./scripts/run-pike-tests.sh`
6. Verify module loading tests run first
7. Verify all tests pass on current Pike version
</verification>

<success_criteria>
1. `.github/workflows/test.yml` includes pike-test job with Pike version matrix
2. Matrix includes "8.1116" (required) and "latest" (best-effort)
3. Latest version has continue-on-error: true
4. `scripts/run-pike-tests.sh` runs all Pike tests in correct order
5. Tests pass on installed Pike version
</success_criteria>

<output>
After completion, create `.planning/phases/05-verification/05-02-SUMMARY.md`
</output>
