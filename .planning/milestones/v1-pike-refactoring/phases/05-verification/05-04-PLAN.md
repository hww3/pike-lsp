---
phase: 05-verification
plan: 04
type: execute
wave: 2
depends_on: [05-01]
files_modified: [test/tests/cross-version-tests.pike]
autonomous: true
user_setup: []

must_haves:
  truths:
    - "All 12 LSP methods are tested on each target Pike version"
    - "Tests verify handlers work correctly across versions"
    - "Version-specific edge cases are tested (Compat.pmod usage, String API differences)"
    - "Cross-version tests can run independently on any Pike version"
  artifacts:
    - path: "test/tests/cross-version-tests.pike"
      provides: "Cross-version handler validation"
      min_lines: 100
      contains: "test_all_handlers_on_current_version"
  key_links:
    - from: "cross-version-tests.pike"
      to: "pike-scripts/LSP.pmod/*.pike"
      via: "master()->resolv() and handler invocation"
      pattern: "(Parser|Intelligence|Analysis)->handle_"
---

<objective>
Create cross-version handler tests that verify all 12 LSP methods work correctly on the target Pike versions.

Purpose: Automated verification that all LSP handlers (parse, tokenize, compile, batch_parse, introspect, resolve, resolve_stdlib, get_inherited, find_occurrences, analyze_uninitialized, get_completion_context, dispatch) produce correct output on each Pike version. This catches version-specific regressions.
Output: Cross-version test file that exercises all handlers with minimal fixtures on the current Pike version.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-verification/05-CONTEXT.md
@.planning/REQUIREMENTS.md

# Prior test files for patterns
@.planning/phases/04-analysis-and-entry-point/04-06-SUMMARY.md

# Existing test infrastructure
@test/tests/parser-tests.pike
@test/tests/intelligence-tests.pike
@test/tests/analysis-tests.pike
@test/tests/response-format-tests.pike
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create cross-version handler tests</name>
  <files>test/tests/cross-version-tests.pike</files>
  <action>
Create `test/tests/cross-version-tests.pike` that validates all 12 LSP handlers work on the current Pike version.

**Test structure:**

1. **test_setup():**
   - Add module path
   - Load LSP modules via master()->resolv()
   - Create handler instances (Parser, Intelligence, Analysis)
   - Log current Pike version

2. **test_parser_handlers():**
   - Test parse_request with simple Pike code
   - Test tokenize_request with simple code
   - Test compile_request with valid Pike code
   - Test batch_parse_request with multiple files
   - Verify each returns valid JSON-RPC response structure

3. **test_intelligence_handlers():**
   - Test handle_introspect on a simple class
   - Test handle_resolve on a symbol
   - Test handle_resolve_stdlib for a stdlib symbol
   - Test handle_get_inherited for inheritance chain
   - Verify each returns valid JSON-RPC response structure

4. **test_analysis_handlers():**
   - Test handle_find_occurrences for a symbol
   - Test handle_analyze_uninitialized for code with uninitialized vars
   - Test handle_get_completion_context for a cursor position
   - Verify each returns valid JSON-RPC response structure

5. **test_dispatch_entry_point():**
   - Test the main dispatch() function in analyzer.pike
   - Verify routing to correct handler for each method
   - Verify error handling for invalid methods

6. **test_compat_edge_cases():**
   - Test Compat.trim_whites() with strings that have different behavior across versions
   - Test String handling that might differ between Pike 8.x versions
   - Verify error responses are properly formatted

**Key design decisions:**
- Use minimal inline fixtures (no external fixture files)
- Each test is self-contained for version isolation
- Tests verify JSON-RPC response structure (result or error field)
- Tests don't verify detailed output (that's what existing tests do)
- Focus on "doesn't crash" and "returns valid response"

**Expected structure:**
- ~150-200 lines
- main() entry point
- Returns 1 for all pass, 0 for any failure
- Uses werror() for progress output

Follow the pattern from `response-format-tests.pike` for JSON-RPC validation.
  </action>
  <verify>pike test/tests/cross-version-tests.pike 2>&1 | tee /tmp/cross-version-test.log</verify>
  <done>All 12 handlers tested with minimal fixtures. Each handler returns valid JSON-RPC response. Test logs Pike version being tested.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate cross-version tests into CI</name>
  <files>.github/workflows/test.yml</files>
<action>
Update `.github/workflows/test.yml` to include cross-version tests in the Pike test job.

1. Add cross-version tests to the pike-test job steps, after the existing test suite:
```yaml
- name: Run Cross-Version Handler Tests
  run: pike test/tests/cross-version-tests.pike
```

2. Add a matrix output summary step that shows:
   - Which version was tested
   - How many handlers passed
   - Overall status

This ensures CI verifies all handlers work on each Pike version in the matrix.
  </action>
  <verify>grep "cross-version-tests" /home/smuks/OpenCode/pike-lsp/.github/workflows/test.yml</verify>
  <done>CI workflow includes cross-version-tests.pike in the Pike test job.</done>
</task>

<task type="auto">
  <name>Task 3: Update test runner script</name>
  <files>scripts/run-pike-tests.sh</files>
  <action>
Update `scripts/run-pike-tests.sh` to include cross-version tests in the test sequence.

Add after E2E tests:
```bash
# Cross-version handler validation
echo "üîç Testing cross-version handler compatibility..."
pike test/tests/cross-version-tests.pike || exit 1
```

Update the summary output to include cross-version test results.
  </action>
  <verify>grep "cross-version" /home/smuks/OpenCode/pike-lsp/scripts/run-pike-tests.sh</verify>
  <done>run-pike-tests.sh includes cross-version-tests.pike in the test sequence.</done>
</task>

</tasks>

<verification>
After completing all tasks:

1. Verify `test/tests/cross-version-tests.pike` exists with all 12 handler tests
2. Run tests: `pike test/tests/cross-version-tests.pike`
3. Verify all handlers are tested (parse, tokenize, compile, batch_parse, introspect, resolve, resolve_stdlib, get_inherited, find_occurrences, analyze_uninitialized, get_completion_context, dispatch)
4. Verify CI workflow includes cross-version tests
5. Verify run-pike-tests.sh includes cross-version tests
6. Verify tests pass on current Pike version
</verification>

<success_criteria>
1. `test/tests/cross-version-tests.pike` tests all 12 LSP handlers
2. Tests verify JSON-RPC response structure for each handler
3. Tests log the Pike version being tested
4. CI runs cross-version tests on each matrix version
5. run-pike-tests.sh includes cross-version tests
6. Tests pass on installed Pike version
</success_criteria>

<output>
After completion, create `.planning/phases/05-verification/05-04-SUMMARY.md`
</output>
