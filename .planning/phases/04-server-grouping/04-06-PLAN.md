---
phase: 04-server-grouping
plan: 06
type: execute
wave: 4
depends_on: [04-01, 04-05]
files_modified:
  - packages/pike-lsp-server/src/server.ts
  - packages/vscode-pike/src/extension.ts
  - packages/vscode-pike/package.json
autonomous: false
user_setup: []

must_haves:
  truths:
    - "VSCode command 'pike.lsp.showDiagnostics' opens output channel with health info"
    - "Health status shows server uptime"
    - "Health status shows bridge connection status and Pike PID"
    - "Health status shows Pike version"
    - "Health status shows recent errors (last 5)"
    - "BridgeManager.getHealth() returns HealthStatus interface"
    - "Command name is consistent across server.ts, extension.ts, and package.json"
  artifacts:
    - path: "packages/pike-lsp-server/src/server.ts"
      provides: "LSP server with health check command"
      contains: "pike.lsp.showDiagnostics"
    - path: "packages/vscode-pike/src/extension.ts"
      provides: "VSCode extension with diagnostics command"
      contains: "pike.lsp.showDiagnostics"
    - path: "packages/vscode-pike/package.json"
      provides: "VSCode extension manifest"
      contains: "pike.lsp.showDiagnostics"
  key_links:
    - from: "extension.ts"
      to: "server.ts"
      via: "workspace/executeCommand"
      pattern: "executeCommand.*pike\\.lsp\\.showDiagnostics"
    - from: "server.ts"
      to: "services/bridge-manager.ts"
      via: "getHealth()"
      pattern: "getHealth\(\)"
    - from: "package.json"
      to: "extension.ts"
      via: "command declaration"
      pattern: "pike\\.lsp\\.showDiagnostics"
---

<objective>
Add health check command to VSCode extension that displays server uptime, bridge status, Pike version, and recent errors.

Purpose: Provide diagnostic visibility into LSP server health for troubleshooting.
Output: Health check command in server.ts and VSCode extension
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Codebase intelligence
@.planning/intel/summary.md

# Source code
@packages/pike-lsp-server/src/server.ts
@packages/vscode-pike/src/extension.ts
@packages/vscode-pike/package.json

# BridgeManager with health tracking
@.planning/phases/04-server-grouping/04-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add health check command handler to server.ts</name>
  <files>packages/pike-lsp-server/src/server.ts</files>
  <action>
Add health check command handler to `packages/pike-lsp-server/src/server.ts`:

**IMPORTANT:** Use dot notation `pike.lsp.showDiagnostics` consistently. This is the standard command naming format.

In the onInitialized handler, register the custom command:

```typescript
connection.onInitialized(async () => {
  // ... existing code ...

  // Register health check command
  connection.workspace.onExecuteCommand(async (params) => {
    if (params.command === 'pike.lsp.showDiagnostics') {
      const health = await bridgeManager?.getHealth();

      // Format health status as readable output
      const lines: string[] = [];
      lines.push('=== Pike LSP Server Health ===');
      lines.push('');

      if (health) {
        const uptime = Math.floor(health.serverUptime / 1000);
        const uptimeStr = uptime > 60
          ? `${Math.floor(uptime / 60)}m ${uptime % 60}s`
          : `${uptime}s`;

        lines.push(`Server Uptime: ${uptimeStr}`);
        lines.push(`Bridge Connected: ${health.bridgeConnected ? 'YES' : 'NO'}`);
        lines.push(`Pike PID: ${health.pikePid ?? 'N/A'}`);
        lines.push(`Pike Version: ${health.pikeVersion ?? 'Unknown'}`);

        if (health.recentErrors.length > 0) {
          lines.push('');
          lines.push('Recent Errors:');
          for (const err of health.recentErrors) {
            lines.push(`  - ${err}`);
          }
        } else {
          lines.push('');
          lines.push('No recent errors');
        }
      } else {
        lines.push('Health status unavailable');
      }

      lines.push('');
      lines.push('============================');

      return lines.join('\n');
    }

    return null;
  });
});
```

Also update the capabilities in onInitialize to include the command:

```typescript
return {
  capabilities: {
    // ... existing capabilities ...
    executeCommandProvider: {
      commands: ['pike.lsp.showDiagnostics'],
    },
  },
};
```

**Note:** The command name uses dot notation (`pike.lsp.showDiagnostics`) which is the standard VSCode command format. Do NOT use slash notation or space notation.
  </action>
  <verify>grep -q "pike\\.lsp\\.showDiagnostics" packages/pike-lsp-server/src/server.ts && grep -q "getHealth" packages/pike-lsp-server/src/server.ts</verify>
  <done>server.ts registers and handles pike.lsp.showDiagnostics command (dot notation)</done>
</task>

<task type="auto">
  <name>Task 2: Register VSCode command in extension.ts</name>
  <files>packages/vscode-pike/src/extension.ts</files>
  <action>
Add health check command registration to `packages/vscode-pike/src/extension.ts`:

**IMPORTANT:** Use the same dot notation `pike.lsp.showDiagnostics` as in server.ts. Consistency is critical.

In the `activateInternal` function, after the existing command registrations:

```typescript
// Health check command
const showDiagnosticsDisposable = commands.registerCommand('pike.lsp.showDiagnostics', async () => {
  if (!client) {
    window.showErrorMessage('Pike LSP client not available');
    return;
  }

  try {
    const result = await client.sendRequest('workspace/executeCommand', {
      command: 'pike.lsp.showDiagnostics',
    });

    const outputChannel = client.outputChannel;
    outputChannel.appendLine(result as string ?? 'No health data available');
    outputChannel.show();

    // Also show as info message
    const summary = (result as string)?.split('\n')?.find((l) => l.includes('Server Uptime') || l.includes('Bridge Connected'));
    if (summary) {
      window.showInformationMessage(`Pike LSP: ${summary}`);
    }
  } catch (err) {
    window.showErrorMessage(`Failed to get diagnostics: ${err}`);
  }
});

context.subscriptions.push(showDiagnosticsDisposable);
```

**Note:** The command name is `pike.lsp.showDiagnostics` (dot notation) - this MUST match exactly with server.ts and package.json.
  </action>
  <verify>grep -q "pike\\.lsp\\.showDiagnostics" packages/vscode-pike/src/extension.ts</verify>
  <done>extension.ts registers pike.lsp.showDiagnostics command (dot notation, consistent with server)</done>
</task>

<task type="auto">
  <name>Task 3: Add command to package.json</name>
  <files>packages/vscode-pike/package.json</files>
  <action>
Update `packages/vscode-pike/package.json` to add the command to the contributes section:

**IMPORTANT:** Use the same dot notation `pike.lsp.showDiagnostics` as in server.ts and extension.ts.

Add to `contributes.commands` array:

```json
{
  "command": "pike.lsp.showDiagnostics",
  "title": "Pike LSP: Show Diagnostics",
  "category": "Pike"
}
```

This makes the command discoverable in the Command Palette.

**Note:** The command name uses dot notation (`pike.lsp.showDiagnostics`) which MUST match exactly with server.ts and extension.ts.
  </action>
  <verify>grep -q "pike\\.lsp\\.showDiagnostics" packages/vscode-pike/package.json</verify>
  <done>package.json declares pike.lsp.showDiagnostics command (dot notation, consistent across all files)</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete health check command integration</what-built>
  <how-to-verify>
1. Build the VSCode extension: `cd packages/vscode-pike && pnpm build`
2. Press F5 in VSCode to launch the Extension Development Host
3. Open a .pike file
4. Open Command Palette (Ctrl+Shift+P / Cmd+Shift+P)
5. Run "Pike LSP: Show Diagnostics"
6. Verify the Output channel shows:
   - Server Uptime
   - Bridge Connected status
   - Pike PID
   - Pike Version (if available)
   - Recent Errors (if any)
7. Verify an info notification appears with a summary

Expected behavior:
- Command appears in Command Palette as "Pike LSP: Show Diagnostics"
- Output channel opens with formatted health info
- Info notification shows summary
- No errors in developer console

If command doesn't appear or execute, check that:
- Command name is `pike.lsp.showDiagnostics` in all three files (server.ts, extension.ts, package.json)
- No typos in command name (dots not slashes, dots not spaces)
  </how-to-verify>
  <resume-signal>Type "approved" if health check works correctly, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. TypeScript compiles in both packages
2. Command is registered in package.json
3. Handler returns formatted health status
4. Command name `pike.lsp.showDiagnostics` is IDENTICAL in server.ts, extension.ts, and package.json
</verification>

<success_criteria>
1. "Pike LSP: Show Diagnostics" command exists in Command Palette
2. Running command opens output channel with health info
3. Health info includes: uptime, bridge status, PID, version, recent errors
4. Summary notification appears
5. Command name uses consistent dot notation across all files
</success_criteria>

<output>
After completion, create `.planning/phases/04-server-grouping/04-06-SUMMARY.md`
</output>
