---
phase: 04-server-grouping
plan: 04
type: execute
wave: 2
depends_on: [04-01]
files_modified:
  - packages/pike-lsp-server/src/features/symbols.ts
  - packages/pike-lsp-server/src/features/diagnostics.ts
  - packages/pike-lsp-server/src/features/index.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "features/symbols.ts exports registerSymbolsHandlers function"
    - "features/diagnostics.ts exports registerDiagnosticsHandlers function"
    - "DocumentSymbol handler returns outline symbols"
    - "WorkspaceSymbol handler searches workspace symbols"
    - "Diagnostics handler validates Pike code and reports errors"
    - "Each handler has try/catch with logger.error fallback"
  artifacts:
    - path: "packages/pike-lsp-server/src/features/symbols.ts"
      provides: "Symbols feature handlers"
      exports: ["registerSymbolsHandlers"]
    - path: "packages/pike-lsp-server/src/features/diagnostics.ts"
      provides: "Diagnostics feature handlers"
      exports: ["registerDiagnosticsHandlers"]
    - path: "packages/pike-lsp-server/src/features/index.ts"
      provides: "Feature module exports"
      exports: ["registerSymbolsHandlers", "registerDiagnosticsHandlers"]
  key_links:
    - from: "features/symbols.ts"
      to: "services/index.ts"
      via: "import type Services"
      pattern: "import.*Services.*from.*services"
    - from: "features/diagnostics.ts"
      to: "services/index.ts"
      via: "import type Services"
      pattern: "import.*Services.*from.*services"
    - from: "features/diagnostics.ts"
      to: "services/document-cache.ts"
      via: "import DocumentCache"
      pattern: "import.*DocumentCache.*from.*document-cache"
    - from: "features/diagnostics.ts"
      to: "services/index.ts"
      via: "typeDatabase in Services interface"
      pattern: "const.*typeDatabase.*=.*services"
    - from: "features/diagnostics.ts"
      to: "type-database.ts"
      via: "typeDatabase usage"
      pattern: "typeDatabase\\."
---

<objective>
Extract symbols and diagnostics handlers from server.ts into dedicated feature modules.

Purpose: Group "show me symbols" and "validate code" handlers separately.
Output: features/symbols.ts and features/diagnostics.ts with registration functions
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Codebase intelligence
@.planning/intel/summary.md

# Source code - server.ts handlers to extract
@packages/pike-lsp-server/src/server.ts

# Services created in 04-01
@.planning/phases/04-server-grouping/04-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract symbols handlers to features/symbols.ts</name>
  <files>packages/pike-lsp-server/src/features/symbols.ts</files>
  <action>
Create `packages/pike-lsp-server/src/features/symbols.ts`:

Extract the following handlers from server.ts into a `registerSymbolsHandlers(connection, services)` function:

1. **onDocumentSymbol** (lines 891-907 in server.ts)
2. **onWorkspaceSymbol** (lines 1605-1650 in server.ts)

Pattern:
```typescript
import { Connection } from 'vscode-languageserver/node.js';
import type { Services } from '../services/index.js';

export function registerSymbolsHandlers(
  connection: Connection,
  services: Services
): void {
  const { bridge, logger, documentCache, workspaceIndex } = services;
  const log = logger.child('symbols');

  connection.onDocumentSymbol((params): DocumentSymbol[] | null => {
    log.debug('Document symbol request', { uri: params.textDocument.uri });
    try {
      // ... handler implementation from server.ts
    } catch (err) {
      log.error('Document symbol failed', { error: err instanceof Error ? err.message : String(err) });
      return null;
    }
  });

  connection.onWorkspaceSymbol((params): SymbolInformation[] => {
    log.debug('Workspace symbol request', { query: params.query });
    try {
      // ... handler implementation from server.ts
    } catch (err) {
      log.error('Workspace symbol failed', { error: err instanceof Error ? err.message : String(err) });
      return [];
    }
  });
}
```

Keep helper functions inside the module:
- convertSymbol
  </action>
  <verify>grep -q "export function registerSymbolsHandlers" packages/pike-lsp-server/src/features/symbols.ts && grep -q "connection.onDocumentSymbol" packages/pike-lsp-server/src/features/symbols.ts && grep -q "connection.onWorkspaceSymbol" packages/pike-lsp-server/src/features/symbols.ts</verify>
  <done>features/symbols.ts exports registerSymbolsHandlers with documentSymbol and workspaceSymbol handlers</done>
</task>

<task type="auto">
  <name>Task 2: Extract diagnostics handlers to features/diagnostics.ts</name>
  <files>packages/pike-lsp-server/src/features/diagnostics.ts</files>
  <action>
Create `packages/pike-lsp-server/src/features/diagnostics.ts`:

Extract the following from server.ts into a `registerDiagnosticsHandlers(connection, services)` function:

1. **Document lifecycle handlers** (lines 364-401 in server.ts):
   - documents.onDidOpen
   - documents.onDidChangeContent
   - documents.onDidSave
   - documents.onDidClose

2. **Validation functions** (lines 715-886 in server.ts):
   - validateDocument
   - validateDocumentDebounced
   - buildDiagnostics
   - convertSeverity

3. **Configuration change handler** (lines 353-362 in server.ts):
   - connection.onDidChangeConfiguration

Pattern:
```typescript
import { Connection, TextDocuments } from 'vscode-languageserver/node.js';
import { TextDocument } from 'vscode-languageserver-textdocument';
import type { Services } from '../services/index.js';
import type { DocumentCacheEntry } from '../core/types.js';

export function registerDiagnosticsHandlers(
  connection: Connection,
  services: Services,
  documents: TextDocuments&lt;TextDocument&gt;
): void {
  const { bridge, logger, documentCache, typeDatabase } = services;
  const log = logger.child('diagnostics');

  const validationTimers = new Map&lt;string, ReturnType&lt;typeof setTimeout&gt;&gt;();

  function validateDocument(document: TextDocument): void {
    // ... implementation from server.ts
  }

  function validateDocumentDebounced(document: TextDocument): void {
    // ... implementation from server.ts
  }

  function buildDiagnostics(
    pikeDiagnostics: import('@pike-lsp/pike-bridge').PikeDiagnostic[],
    document: TextDocument
  ): import('vscode-languageserver/node').Diagnostic[] {
    // ... implementation from server.ts
  }

  function convertSeverity(severity: string): import('vscode-languageserver/node').DiagnosticSeverity {
    // ... implementation from server.ts
  }

  // Document lifecycle
  documents.onDidOpen((event) => {
    log.debug('Document opened', { uri: event.document.uri });
    try {
      validateDocument(event.document);
    } catch (err) {
      log.error('Document open validation failed', { error: err instanceof Error ? err.message : String(err) });
    }
  });

  documents.onDidChangeContent((change) => {
    try {
      validateDocumentDebounced(change.document);
    } catch (err) {
      log.error('Document change validation failed', { error: err instanceof Error ? err.message : String(err) });
    }
  });

  documents.onDidSave((event) => {
    try {
      validateDocument(event.document);
    } catch (err) {
      log.error('Document save validation failed', { error: err instanceof Error ? err.message : String(err) });
    }
  });

  documents.onDidClose((event) => {
    // ... clear cache, diagnostics, timers
  });

  connection.onDidChangeConfiguration((change) => {
    // ... update settings, revalidate documents
  });
}

export type { DiagnosticsServices };
```

Note: This module receives `documents` as a parameter since it's created in server.ts, not in Services.
  </action>
  <verify>grep -q "export function registerDiagnosticsHandlers" packages/pike-lsp-server/src/features/diagnostics.ts && grep -q "documents.onDidOpen" packages/pike-lsp-server/src/features/diagnostics.ts && grep -q "onDidChangeConfiguration" packages/pike-lsp-server/src/features/diagnostics.ts</verify>
  <done>features/diagnostics.ts exports registerDiagnosticsHandlers with document lifecycle and validation</done>
</task>

<task type="auto">
  <name>Task 3: Update features/index.ts to export symbols and diagnostics</name>
  <files>packages/pike-lsp-server/src/features/index.ts</files>
  <action>
Update `packages/pike-lsp-server/src/features/index.ts`:

```typescript
export { registerNavigationHandlers } from './navigation.js';
export { registerEditingHandlers } from './editing.js';
export { registerSymbolsHandlers } from './symbols.js';
export { registerDiagnosticsHandlers } from './diagnostics.js';
```
  </action>
  <verify>grep -q "registerSymbolsHandlers\|registerDiagnosticsHandlers" packages/pike-lsp-server/src/features/index.ts</verify>
  <done>features/index.ts re-exports all feature registration functions</done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `cd packages/pike-lsp-server && npx tsc --noEmit`
2. All symbol and diagnostic handlers are exported
3. Each handler has try/catch with logging fallback
4. typeDatabase is destructured from services in diagnostics.ts
</verification>

<success_criteria>
1. features/symbols.ts exists with registerSymbolsHandlers
2. features/diagnostics.ts exists with registerDiagnosticsHandlers
3. Document lifecycle handlers are in diagnostics.ts
4. features/index.ts re-exports both new handlers
5. typeDatabase is available to diagnostics via Services interface
</success_criteria>

<output>
After completion, create `.planning/phases/04-server-grouping/04-04-SUMMARY.md`
</output>
