---
phase: 11-startup-optimization
plan: 04
type: execute
wave: 2
depends_on: [11-01]
files_modified:
  - packages/pike-lsp-server/src/services/bridge-manager.ts
  - packages/pike-lsp-server/src/server.ts
autonomous: true
must_haves:
  truths:
    - "BridgeManager.start() completes without waiting for version fetch"
    - "Version info is fetched asynchronously after bridge starts"
    - "LSP server becomes ready faster (perceived startup improvement)"
  artifacts:
    - path: "packages/pike-lsp-server/src/services/bridge-manager.ts"
      provides: "Async version fetching in start()"
      contains: "non-blocking getVersionInfo() call"
    - path: "packages/pike-lsp-server/src/server.ts"
      provides: "Updated initialization flow"
      contains: "async version fetch pattern"
  key_links:
    - from: "bridge-manager.ts start()"
      to: "getVersionInfo()"
      via: "async fire-and-forget pattern"
      pattern: "getVersionInfo.*catch"
    - from: "server.ts onInitialize"
      to: "bridge.start()"
      via: "returns immediately after subprocess spawn"
      pattern: "await.*start\\(\\)"
---

<objective>
Make the version fetch in BridgeManager.start() asynchronous to reduce perceived LSP startup time.

Purpose: Currently, BridgeManager.start() waits for version info via RPC (100-300ms) before returning. This blocks the LSP initialization. By making version fetch async, the LSP server becomes ready sooner and version info arrives in the background.

Output: BridgeManager.start() returns immediately after subprocess starts; version info fetched asynchronously; LSP initialization completes faster.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 11 Context
@.planning/phases/11-startup-optimization/11-CONTEXT.md

# Current code
@packages/pike-lsp-server/src/services/bridge-manager.ts
@packages/pike-lsp-server/src/server.ts

# Prior work
@.planning/phases/11-startup-optimization/11-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Make version fetch asynchronous in BridgeManager.start()</name>
  <files>packages/pike-lsp-server/src/services/bridge-manager.ts</files>
  <action>
Modify bridge-manager.ts to fetch version info asynchronously:

1. In start() method, after `await this.bridge.start();`, initiate async version fetch:
   ```typescript
   await this.bridge.start();

   // Fetch version info asynchronously (fire and forget)
   this.fetchVersionInfoAsync();
   ```

2. Create a new private method `fetchVersionInfoAsync()`:
   ```typescript
   private async fetchVersionInfoAsync(): Promise<void> {
       if (!this.bridge) return;

       try {
           const versionInfo = await this.bridge.getVersionInfo();
           if (versionInfo) {
               const diagnostics = this.bridge.getDiagnostics();
               const pikePath = diagnostics.options.pikePath;
               let resolvedPath: string;

               if (pikePath === 'pike') {
                   resolvedPath = 'pike';
               } else {
                   resolvedPath = fs.realpathSync(pikePath);
               }

               this.cachedVersion = {
                   ...versionInfo,
                   pikePath: resolvedPath,
               };
               this.logger.info('Pike version detected (async)', {
                   version: versionInfo.version,
                   path: resolvedPath,
               });
           }
       } catch (err) {
           const message = err instanceof Error ? err.message : String(err);
           this.logger.warn('Failed to get Pike version info (async)', { error: message });
       }
   }
   ```

3. Move the existing version fetch code from start() into this new method.

4. Update the startup timing to record "bridge_ready" before async version fetch starts.

This makes start() return immediately after subprocess spawn, reducing perceived startup time.
  </action>
  <verify>
1. Build project: `cd packages/pike-lsp-server && pnpm build`
2. Check TypeScript compiles without errors
3. Verify getHealth() eventually shows version info (after async fetch completes)
  </verify>
  <done>BridgeManager.start() returns immediately; version info fetched asynchronously</done>
</task>

<task type="auto">
  <name>Task 2: Add pending state for async version fetch</name>
  <files>packages/pike-lsp-server/src/services/bridge-manager.ts</files>
  <action>
Add tracking for async version fetch state:

1. Add a private field to track version fetch status:
   ```typescript
   private versionFetchPromise: Promise<void> | null = null;
   ```

2. In fetchVersionInfoAsync(), store the promise:
   ```typescript
   this.versionFetchPromise = this.fetchVersionInfoAsync().finally(() => {
       this.versionFetchPromise = null;
   });
   ```

   Wait - this creates circular reference. Instead:

3. Store the promise at call site:
   ```typescript
   // In start() method
   this.versionFetchPromise = this.fetchVersionInfoInternal().finally(() => {
       this.versionFetchPromise = null;
   });
   ```

4. Rename the async method to `fetchVersionInfoInternal()` and update accordingly.

5. Update HealthStatus interface to include version fetch state:
   ```typescript
   export interface HealthStatus {
       // ... existing fields
       versionFetchPending?: boolean;
   }
   ```

6. In getHealth(), report if version fetch is pending:
   ```typescript
   versionFetchPending: this.versionFetchPromise !== null,
   ```

This allows callers to know if version info is still being fetched.
  </action>
  <verify>
1. Build project: `cd packages/pike-lsp-server && pnpm build`
2. Check TypeScript compiles without errors
3. Test that health status shows versionFetchPending: true initially
  </verify>
  <done>Async version fetch state is tracked and reported in health status</done>
</task>

</tasks>

<verification>
Overall verification:
1. Run `pnpm bench` in packages/pike-lsp-server to verify bridge start time is reduced
2. Compare "bridge_ready" timing with previous run - should be ~100-300ms faster
3. Verify E2E tests still pass: `cd packages/vscode-pike && pnpm test:features`
4. Confirm getHealth() shows versionFetchPending initially, then resolves
</verification>

<success_criteria>
1. BridgeManager.start() returns 100-300ms faster (no waiting for version)
2. Version info is eventually available in health status
3. Health status indicates when version fetch is pending
4. All existing functionality works
5. E2E tests pass without modification
</success_criteria>

<output>
After completion, create `.planning/phases/11-startup-optimization/11-04-SUMMARY.md`
</output>
