---
phase: 11-startup-optimization
plan: 03
type: execute
wave: 2
depends_on: [11-01]
files_modified:
  - pike-scripts/analyzer.pike
autonomous: true
must_haves:
  truths:
    - "Pike subprocess starts without loading LSP.Compat module"
    - "Version logging uses __VERSION__ directly"
    - "get_version handler still works (loads Compat on demand)"
  artifacts:
    - path: "pike-scripts/analyzer.pike"
      provides: "Startup without Compat module load"
      contains: "__VERSION__ instead of LSP.Compat"
  key_links:
    - from: "analyzer.pike main()"
      to: "__VERSION__"
      via: "direct version constant"
      pattern: "__VERSION__"
    - from: "get_version handler"
      to: "LSP.Compat"
      via: "on-demand module load"
      pattern: "master\\(\\)->resolv\\(\"LSP.Compat\"\\)"
---

<objective>
Remove the LSP.Compat module load at startup by using Pike's built-in __VERSION__ constant for version logging.

Purpose: Loading LSP.Compat just to log the Pike version takes 10-30ms at startup. Pike provides __VERSION__ as a built-in constant that requires no module loading. The Compat module is still available for get_version RPC calls, but loaded on-demand.

Output: Startup is 10-30ms faster; version logging uses built-in constant; get_version handler still works via on-demand Compat loading.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 11 Context
@.planning/phases/11-startup-optimization/11-CONTEXT.md

# Current code
@pike-scripts/analyzer.pike

# Prior work
@.planning/phases/11-startup-optimization/11-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace LSP.Compat version logging with __VERSION__</name>
  <files>pike-scripts/analyzer.pike</files>
  <action>
In analyzer.pike, replace the Compat-based version logging:

1. Find the version logging lines (136-138):
   ```pike
   // OLD CODE - Remove this
   array(int) version = master()->resolv("LSP.Compat")->pike_version();
   werror("Pike LSP Analyzer running on Pike %d.%d.%d\n",
          version[0], version[1], version[2]);
   ```

2. Replace with __VERSION__ direct access:
   ```pike
   // NEW CODE - Use built-in constant
   werror("Pike LSP Analyzer running on Pike %s\n", __VERSION__);
   ```

   Note: __VERSION__ in Pike is a pre-defined constant containing the version string.

3. Add timing after version logging if startup_phases exists:
   ```pike
   if (startup_phases) {
       startup_phases->version = startup_timer->peek() * 1000.0;
   }
   ```

This eliminates the master()->resolv("LSP.Compat") call at startup.
  </action>
  <verify>
1. Check pike-scripts/analyzer.pike compiles: `pike -e 'compile_file("pike-scripts/analyzer.pike");'`
2. Run analyzer and verify version is logged correctly:
   ```bash
   echo '{"jsonrpc":"2.0","id":1,"method":"parse","params":{"code":"int x;"}}' | pike pike-scripts/analyzer.pike 2>&1 | head -5
   ```
   Should see "Pike LSP Analyzer running on Pike X.X.XXXX"
3. Compare startup time with previous benchmark
  </verify>
  <done>Version logging uses __VERSION__ without loading LSP.Compat module</done>
</task>

<task type="auto">
  <name>Task 2: Verify get_version handler still works</name>
  <files>pike-scripts/analyzer.pike</files>
  <action>
Verify the get_version handler still works correctly:

1. The get_version handler (lines 185-196) already uses LSP.Compat on-demand:
   ```pike
   "get_version": lambda(mapping params, object ctx) {
       array(int) ver = master()->resolv("LSP.Compat")->pike_version();
       // ...
   },
   ```

2. This is correct - it loads LSP.Compat only when get_version is called via RPC.

3. Add timing to track the first Compat load:
   - In the get_version handler, track if this is the first time Compat is loaded
   - If so, record the timing in startup_phases

4. NO changes needed to the handler itself - it already loads Compat on-demand.

This ensures backward compatibility while avoiding startup load.
  </action>
  <verify>
1. Test get_version RPC call works:
   ```bash
   echo '{"jsonrpc":"2.0","id":1,"method":"get_version","params":{}}' | pike pike-scripts/analyzer.pike
   ```
   Should return version info with major, minor, build fields.
2. Verify the response includes correct version data
3. Check that subsequent get_version calls don't reload Compat (Pike caches master()->resolv results)
  </verify>
  <done>get_version handler works correctly via on-demand LSP.Compat loading</done>
</task>

</tasks>

<verification>
Overall verification:
1. Run `pnpm bench` in packages/pike-lsp-server to verify startup time improvement
2. Compare "version" phase timing with previous run - should be ~10-30ms faster
3. Verify E2E tests still pass: `cd packages/vscode-pike && pnpm test:features`
4. Confirm version logging in stderr shows correct Pike version
</verification>

<success_criteria>
1. Version logging phase is 10-30ms faster (no LSP.Compat load)
2. get_version RPC handler still returns correct version info
3. All existing functionality works
4. E2E tests pass without modification
</success_criteria>

<output>
After completion, create `.planning/phases/11-startup-optimization/11-03-SUMMARY.md`
</output>
