---
phase: 11-startup-optimization
plan: 02
type: execute
wave: 2
depends_on: [11-01]
files_modified:
  - pike-scripts/analyzer.pike
autonomous: true
must_haves:
  truths:
    - "Pike subprocess starts without loading Parser, Intelligence, or Analysis modules"
    - "Context is created only when first request arrives"
    - "First request triggers lazy Context creation"
    - "Subsequent requests use the already-created Context"
  artifacts:
    - path: "pike-scripts/analyzer.pike"
      provides: "Lazy Context creation pattern"
      contains: "Context created on first request, not at startup"
    - path: "pike-scripts/analyzer.pike"
      provides: "Null-safe Context access in handlers"
      contains: "deferred Context initialization"
  key_links:
    - from: "analyzer.pike main()"
      to: "Context.create()"
      via: "deferred until first request"
      pattern: "!ctx_initialized"
    - from: "dispatch()"
      to: "Context"
      via: "lazy initialization on first call"
      pattern: "if.*ctx.*==.*null"
---

<objective>
Implement lazy Context creation in the Pike analyzer to defer module loading until the first request arrives.

Purpose: Context.create() currently loads Parser, Intelligence, and Analysis modules synchronously at startup (50-200ms). By deferring Context creation until the first request, the subprocess starts faster and the LSP server becomes responsive sooner.

Output: Pike subprocess starts without loading analysis modules; first request triggers module load; subsequent requests use cached Context.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 11 Context
@.planning/phases/11-startup-optimization/11-CONTEXT.md

# Current code
@pike-scripts/analyzer.pike

# Prior work
@.planning/phases/11-startup-optimization/11-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Defer Context creation to first request</name>
  <files>pike-scripts/analyzer.pike</files>
  <action>
Modify analyzer.pike to defer Context creation:

1. Remove the Context creation from main() (delete line 200: `Context ctx = Context();`)

2. Add a variable to track Context initialization:
   ```pike
   // Context will be created on first request
   Context ctx = 0;
   int ctx_initialized = 0;
   ```

3. Create a helper function to ensure Context is initialized:
   ```pike
   Context get_context() {
       if (!ctx_initialized) {
           object timer = System.Timer();
           ctx = Context();
           ctx_initialized = 1;
           // Record timing if startup_phases exists
           if (startup_phases) {
               startup_phases->context_lazy = timer->peek() * 1000.0;
           }
       }
       return ctx;
   }
   ```

4. Update handle_request() to use get_context():
   - Replace `Context ctx` parameter with Context passed from main loop
   - In the main loop, call `get_context()` before dispatch

5. Update main() loop to pass Context to handle_request:
   ```pike
   while ((line = Stdio.stdin.gets())) {
       if (sizeof(String.trim_all_whites(line)) == 0) continue;

       mixed err = catch {
           mapping request = Standards.JSON.decode(line);
           Context current_ctx = get_context();  // Lazy initialization
           mapping response = handle_request(request, current_ctx);
           // ... rest of loop
       };
   }
   ```

This ensures Context is only created when the first request arrives.
  </action>
  <verify>
1. Check pike-scripts/analyzer.pike compiles: `pike -e 'compile_file("pike-scripts/analyzer.pike");'`
2. Test that subprocess starts faster (should return to prompt immediately):
   ```bash
   time echo '{"jsonrpc":"2.0","id":1,"method":"get_startup_metrics","params":{}}' | pike pike-scripts/analyzer.pike
   ```
3. Verify first request still works by sending a parse request
  </verify>
  <done>Pike subprocess starts without Context; first request triggers Context creation</done>
</task>

<task type="auto">
  <name>Task 2: Update startup timing to reflect lazy Context</name>
  <files>pike-scripts/analyzer.pike</files>
  <action>
Update startup phase timing to account for lazy Context creation:

1. In main(), after the JSON-RPC loop would start (before while loop), record the "ready" time:
   ```pike
   // Server is ready to accept requests (but Context not created yet)
   startup_phases->ready = startup_timer->peek() * 1000.0;
   ```

2. In get_context(), record the lazy context creation time:
   ```pike
   startup_phases->context_lazy = timer->peek() * 1000.0;
   startup_phases->total_with_first_request = startup_timer->peek() * 1000.0;
   ```

3. Update get_startup_metrics to include the new timing info:
   - Return "ready" time (time to start listening for requests)
   - Return "context_lazy" time (time to create Context on first request)
   - Return "total_with_first_request" (full startup including first request)

4. Add a boolean flag "context_created" to indicate whether Context has been created yet.

This separates "startup" (subprocess ready) from "first request" (module loading).
  </action>
  <verify>
1. Test get_startup_metrics returns new timing fields:
   ```bash
   echo '{"jsonrpc":"2.0","id":1,"method":"get_startup_metrics","params":{}}' | pike pike-scripts/analyzer.pike
   ```
2. Verify "ready" time is less than previous "total" time
3. Verify "context_lazy" is populated after first request
  </verify>
  <done>Startup timing accurately reflects lazy Context creation pattern</done>
</task>

</tasks>

<verification>
Overall verification:
1. Run `pnpm bench` in packages/pike-lsp-server to verify startup time is reduced
2. Compare "ready" time vs previous "total" time - should be ~50-200ms faster
3. Verify E2E tests still pass: `cd packages/vscode-pike && pnpm test:features`
4. Confirm get_startup_metrics shows Context is created lazily
</verification>

<success_criteria>
1. Pike subprocess "ready" time is reduced by 50-200ms (no Context creation at startup)
2. First request triggers Context creation (visible in startup_metrics)
3. All existing functionality works (parse, introspect, etc.)
4. E2E tests pass without modification
</success_criteria>

<output>
After completion, create `.planning/phases/11-startup-optimization/11-02-SUMMARY.md`
</output>
