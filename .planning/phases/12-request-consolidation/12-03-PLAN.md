---
phase: 12-request-consolidation
plan: 03
type: execute
wave: 2
depends_on: ["12-01"]
files_modified: [pike-scripts/analyzer.pike]
autonomous: true
must_haves:
  truths:
    - "introspect handler calls handle_analyze with include: ['introspect']"
    - "parse handler calls handle_analyze with include: ['parse']"
    - "analyze_uninitialized handler calls handle_analyze with include: ['diagnostics']"
    - "Each wrapper extracts the relevant result and returns in the original format"
    - "Deprecation warnings are logged for old methods"
  artifacts:
    - path: "pike-scripts/analyzer.pike"
      provides: "Backward-compatible wrapper handlers"
      contains: "introspect.*deprecated"
  key_links:
    - from: "introspect handler"
      to: "handle_analyze"
      via: "include: ['introspect']"
    - from: "parse handler"
      to: "handle_analyze"
      via: "include: ['parse']"
---

<objective>
Convert existing JSON-RPC handlers to thin wrappers calling analyze().

Purpose: Maintain backward compatibility for existing clients while consolidating implementation.
Output: All old methods work exactly as before, but delegate to analyze() internally.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-request-consolidation/12-CONTEXT.md
@.planning/phases/12-request-consolidation/12-RESEARCH.md
@.planning/phases/12-request-consolidation/12-01-SUMMARY.md
@pike-scripts/analyzer.pike
@pike-scripts/LSP.pmod/Analysis.pike
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add analyze handler to HANDLERS table</name>
  <files>pike-scripts/analyzer.pike</files>
  <action>
    Add "analyze" entry to HANDLERS mapping in main():
    - Delegates to ctx->analysis->handle_analyze(params)
    - Follows same pattern as other Analysis methods
    - Position: Add after "analyze_uninitialized" entry for logical grouping
  </action>
  <verify>echo '{"jsonrpc":"2.0","id":1,"method":"analyze","params":{"code":"int x;","include":["parse"]}}' | pike pike pike-scripts/analyzer.pike succeeds</verify>
  <done>analyze method is accessible via JSON-RPC.</done>
</task>

<task type="auto">
  <name>Task 2: Convert introspect handler to wrapper</name>
  <files>pike-scripts/analyzer.pike</files>
  <action>
    Modify the "introspect" handler lambda:
    - Instead of directly calling ctx->intelligence->handle_introspect(params)
    - Call ctx->analysis->handle_analyze(params + (["include":({"introspect"})]))
    - Extract result.introspect from the response
    - If failures?.introspect exists, convert to error response
    - Log deprecation warning: werror("[DEPRECATED] introspect method - use analyze with include: ['introspect']\n")
    - Return the exact same response format as original introspect

    CRITICAL: Response format must be byte-for-byte identical to original for backward compatibility.
  </action>
  <verify>Old introspect calls still return exact same format as before.</verify>
  <done>introspect handler delegates to analyze() with deprecation warning.</done>
</task>

<task type="auto">
  <name>Task 3: Convert parse handler to wrapper</name>
  <files>pike-scripts/analyzer.pike</files>
  <action>
    Modify the "parse" handler lambda:
    - Call ctx->analysis->handle_analyze(params + (["include":({"parse"})]))
    - Extract result.parse from the response
    - If failures?.parse exists, convert to error response
    - Log deprecation warning
    - Return exact same format as original parse_request()

    Original parse_request returns: { result: { symbols, diagnostics } }
  </action>
  <verify>Old parse calls still return exact same format as before.</verify>
  <done>parse handler delegates to analyze() with deprecation warning.</done>
</task>

<task type="auto">
  <name>Task 4: Convert analyze_uninitialized handler to wrapper</name>
  <files>pike-scripts/analyzer.pike</files>
  <action>
    Modify the "analyze_uninitialized" handler lambda:
    - Call ctx->analysis->handle_analyze(params + (["include":({"diagnostics"})]))
    - Extract result.diagnostics from the response
    - If failures?.diagnostics exists, convert to error response
    - Log deprecation warning
    - Return exact same format as original handle_analyze_uninitialized()

    Original returns: { result: { diagnostics } }
  </action>
  <verify>Old analyze_uninitialized calls still return exact same format.</verify>
  <done>analyze_uninitialized handler delegates to analyze() with deprecation warning.</done>
</task>

</tasks>

<verification>
1. Run E2E test: cd packages/vscode-pike && pnpm test:features
2. Verify all existing LSP features still work (symbols, hover, go-to-definition, completion)
3. Check that deprecation warnings appear in stderr for old method calls
</verification>

<success_criteria>
All existing JSON-RPC methods work identically but now delegate to analyze() internally with deprecation warnings.
</success_criteria>

<output>
After completion, create `.planning/phases/12-request-consolidation/12-03-SUMMARY.md`
</output>
