---
phase: 12-request-consolidation
plan: 04
type: execute
wave: 2
depends_on: ["12-02"]
files_modified: [packages/pike-lsp-server/src/features/diagnostics.ts]
autonomous: true
must_haves:
  truths:
    - "validateDocument() calls analyze() once with all include types"
    - "Results are cached and distributed to LSP features"
    - "Only 1 Pike IPC call per document change instead of 3+"
    - "All LSP features (symbols, hover, completion) still work"
  artifacts:
    - path: "packages/pike-lsp-server/src/features/diagnostics.ts"
      provides: "Validation pipeline using consolidated analyze"
      contains: "analyze(['parse', 'introspect', 'diagnostics'])"
  key_links:
    - from: "validateDocument()"
      to: "bridge.analyze()"
      via: "single call with include array"
    - from: "AnalyzeResponse.result"
      to: "documentCache/typeDatabase"
      via: "result distribution"
---

<objective>
Rewrite validation pipeline to use single analyze() call instead of 3 separate calls.

Purpose: Eliminate redundant Pike IPC overhead during document validation.
Output: validateDocument() makes exactly 1 Pike call and distributes results to all features.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-request-consolidation/12-CONTEXT.md
@.planning/phases/12-request-consolidation/12-RESEARCH.md
@.planning/phases/12-request-consolidation/12-02-SUMMARY.md
@packages/pike-lsp-server/src/features/diagnostics.ts
@packages/pike-bridge/src/bridge.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace 3 calls with single analyze() call</name>
  <files>packages/pike-lsp-server/src/features/diagnostics.ts</files>
  <action>
    In validateDocument(), replace the current pattern:
      const introspectResult = await bridge.introspect(text, filename);
      const parseResult = await bridge.parse(text, filename);
      const uninitResult = await bridge.analyzeUninitialized(text, filename);

    With a single call:
      const analyzeResult = await bridge.analyze(text, filename, ['parse', 'introspect', 'diagnostics']);

    Then handle partial failures:
      - Check analyzeResult.failures for each type
      - Use fallback/default values for failed components
      - Log warnings but don't fail entire validation

    Example:
      const parseData = analyzeResult.failures?.parse ? { symbols: [], diagnostics: [] } : analyzeResult.result.parse;
      const introspectData = analyzeResult.failures?.introspect ? { success: 0, symbols: [], ... } : analyzeResult.result.introspect;
      const diagnosticsData = analyzeResult.failures?.diagnostics ? { diagnostics: [] } : analyzeResult.result.diagnostics;
  </action>
  <verify>TypeScript compiles: cd packages/pike-lsp-server && pnpm build</verify>
  <done>validateDocument() uses single analyze() call with partial failure handling.</done>
</task>

<task type="auto">
  <name>Task 2: Update result processing for new structure</name>
  <files>packages/pike-lsp-server/src/features/diagnostics.ts</files>
  <action>
    Update all references to introspectResult, parseResult, uninitResult:
    - Replace introspectResult.symbols with introspectData.symbols
    - Replace introspectResult.diagnostics with introspectData.diagnostics
    - Replace parseResult.symbols with parseData.symbols
    - Replace parseResult.diagnostics with parseData.diagnostics
    - Replace uninitResult.diagnostics with diagnosticsData.diagnostics

    Keep all existing logic for:
    - Converting diagnostics
    - Building type database entries
    - Flattening symbols
    - Building symbol position index
    - Sending diagnostics to client
  </action>
  <verify>TypeScript compiles successfully.</verify>
  <done>All result processing uses consolidated analyze response data.</done>
</task>

<task type="auto">
  <name>Task 3: Add logging to verify single call</name>
  <files>packages/pike-lsp-server/src/features/diagnostics.ts</files>
  <action>
    Add console.log statements to verify optimization:
    - Before analyze call: connection.console.log(`[VALIDATE] Calling unified analyze for: ${filename}`);
    - After analyze call: connection.console.log(`[VALIDATE] Analyze completed - parse: ${!!analyzeResult.result.parse}, introspect: ${!!analyzeResult.result.introspect}, diagnostics: ${!!analyzeResult.result.diagnostics}`);
    - Log any failures: connection.console.log(`[VALIDATE] Partial failures: ${Object.keys(analyzeResult.failures || {}).join(', ')}`);

    This confirms the single-call optimization is working.
  </action>
  <verify>Logs show single analyze call instead of 3 separate calls.</verify>
  <done>Logging confirms single-call behavior during validation.</done>
</task>

</tasks>

<verification>
1. Run E2E test: cd packages/vscode-pike && pnpm test:features
2. Verify all LSP features still work (document symbols, hover, go-to-definition, completion)
3. Check connection console logs show single analyze call per validation
</verification>

<success_criteria>
Document validation makes exactly 1 Pike call instead of 3, with all features still functional.
</success_criteria>

<output>
After completion, create `.planning/phases/12-request-consolidation/12-04-SUMMARY.md`
</output>
