---
phase: 12-request-consolidation
plan: 05
type: execute
wave: 3
depends_on: ["12-04"]
files_modified: [packages/pike-lsp-server/benchmarks/runner.ts]
autonomous: true
must_haves:
  truths:
    - "Benchmark measures old approach (3 calls) vs new approach (1 call)"
    - "Latency reduction is quantified and measurable"
    - "CI regression gate validates the improvement"
  artifacts:
    - path: "packages/pike-lsp-server/benchmarks/runner.ts"
      provides: "Request consolidation benchmarks"
      contains: "ValidationConsolidated"
  key_links:
    - from: "benchmarks/runner.ts"
      to: "bridge.analyze()"
      via: "benchmark suite"
    - from: "benchmark results"
      to: "CI regression gate"
      via: "20% threshold"
---

<objective>
Run benchmarks to validate latency reduction from request consolidation.

Purpose: Measure the actual performance improvement and ensure no regression.
Output: Benchmark results showing measurable reduction in validation latency.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-benchmarking-infrastructure/10-01-SUMMARY.md
@.planning/phases/10-benchmarking-infrastructure/10-02-SUMMARY.md
@.planning/phases/10-benchmarking-infrastructure/10-03-SUMMARY.md
@.planning/phases/12-request-consolidation/12-04-SUMMARY.md
@packages/pike-lsp-server/benchmarks/runner.ts
@packages/pike-lsp-server/benchmark-results.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Request Consolidation benchmark suite</name>
  <files>packages/pike-lsp-server/benchmarks/runner.ts</files>
  <action>
    Add a new "Request Consolidation" benchmark group to runner.ts:
    - "Validation Legacy": Measures 3 separate calls (introspect + parse + analyzeUninitialized)
      - Use medium.pike fixture
      - Make 3 sequential bridge calls
      - Report combined time
    - "Validation Consolidated": Measures 1 analyze() call
      - Use same medium.pike fixture
      - Call bridge.analyze() with all include types
      - Report time
    - "Improvement Ratio": Calculate (LegacyTime / ConsolidatedTime)
      - Shows the speedup factor (e.g., "2.5x faster")

    Include _perf breakdown if available (compilation_ms, tokenization_ms).
  </action>
  <verify>pnpm benchmark shows Request Consolidation group with all 3 benchmarks.</verify>
  <done>Benchmark suite measures before/after performance.</done>
</task>

<task type="auto">
  <name>Task 2: Run baseline and consolidated benchmarks</name>
  <files>packages/pike-lsp-server/benchmark-results.json</files>
  <action>
    1. Run full benchmark suite: cd packages/pike-lsp-server && pnpm benchmark
    2. Save results to benchmark-results.json
    3. Extract the "Request Consolidation" group results
    4. Calculate improvement: (Legacy - Consolidated) / Legacy * 100%

    Expected: Consolidated approach should be ~50-70% faster due to:
    - 1 IPC round-trip instead of 3
    - 1 compilation instead of 3
    - 1 tokenization instead of 3
  </action>
  <verify>benchmark-results.json contains new Request Consolidation results.</verify>
  <done>Benchmark results quantify the performance improvement.</done>
</task>

<task type="auto">
  <name>Task 3: Verify CI regression gate</name>
  <files>packages/pike-lsp-server/benchmark-results.json</files>
  <action>
    1. Run the CI benchmark script that checks for regressions
    2. Verify the 20% regression threshold from Phase 10 is still working
    3. Confirm that the "Validation Consolidated" time is tracked
    4. If regression detected, log what changed

    The CI gate should fail if:
    - Validation Consolidated time > 20% worse than baseline
    - Or any existing benchmark regresses
  </action>
  <verify>CI benchmark script runs and passes (or shows meaningful regression if something broke).</verify>
  <done>CI regression gate validates the consolidation improvement.</done>
</task>

</tasks>

<verification>
1. Run pnpm benchmark and verify Request Consolidation group exists
2. Verify Consolidated time is measurably lower than Legacy time
3. Run CI benchmark script and confirm no regressions
</verification>

<success_criteria>
Benchmarks show measurable latency reduction (target: 50%+ faster) and CI regression gate passes.
</success_criteria>

<output>
After completion, create `.planning/phases/12-request-consolidation/12-05-SUMMARY.md`
</output>
