name: Test

on:
  push:
    branches: [main, master]
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - 'LICENSE'
      - '.claude/**'
      - '.omc/**'
      - 'docusaurus.config.ts'
      - 'sidebars.ts'
  pull_request:
    branches: [main, master]
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - 'LICENSE'
      - '.claude/**'
      - '.omc/**'
      - 'docusaurus.config.ts'
      - 'sidebars.ts'

concurrency:
  group: test-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  test:
    runs-on: ubuntu-24.04

    strategy:
      matrix:
        node-version: [20.x]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache bun dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: bun-${{ runner.os }}-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            bun-${{ runner.os }}-

      - name: Cache apt packages
        uses: actions/cache@v4
        with:
          path: /var/cache/apt/archives/*.deb
          key: apt-${{ runner.os }}-test-pike8.0
          restore-keys: |
            apt-${{ runner.os }}-test-
            apt-${{ runner.os }}-

      - name: Install dependencies
        run: bun install

      - name: Install Pike
        run: |
          sudo apt-get update
          sudo apt-get install -y pike8.0

      - name: Verify Pike installation
        run: |
          pike --version
          which pike

      - name: Build all packages
        run: bun run build

      - name: Run Pike Bridge tests
        run: cd packages/pike-bridge && bun test

      - name: Run LSP Server tests
        run: cd packages/pike-lsp-server && bun test

      - name: Run LSP smoke tests
        run: cd packages/pike-lsp-server && bun test ./src/tests/smoke.test.ts

      - name: Run integration tests
        run: cd packages/pike-lsp-server && bun test ./dist/tests/integration-tests.js

  pike-test:
    runs-on: ubuntu-24.04

    strategy:
      matrix:
        pike-version: ['8.1116', 'latest']
      fail-fast: true

    continue-on-error: ${{ matrix.pike-version == 'latest' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache bun dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: bun-${{ runner.os }}-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            bun-${{ runner.os }}-

      - name: Cache apt packages
        uses: actions/cache@v4
        with:
          path: /var/cache/apt/archives/*.deb
          key: apt-${{ runner.os }}-build-extension-pike8.0
          restore-keys: |
            apt-${{ runner.os }}-build-extension-
            apt-${{ runner.os }}-

      - name: Cache apt packages
        uses: actions/cache@v4
        with:
          path: /var/cache/apt/archives/*.deb
          key: apt-${{ runner.os }}-pike-${{ matrix.pike-version }}
          restore-keys: |
            apt-${{ runner.os }}-pike-

      - name: Cache Pike 8.1116 toolchain
        if: matrix.pike-version == '8.1116'
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pike/8.0.1116
            ~/.cache/pike/distfiles
          key: pike-toolchain-${{ runner.os }}-8.0.1116-v2

      - name: Cache Pike latest toolchain
        if: matrix.pike-version == 'latest'
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pike/8.0.1956
            ~/.cache/pike/distfiles
          key: pike-toolchain-${{ runner.os }}-8.0.1956-v1

      - name: Install Pike ${{ matrix.pike-version }}
        run: |
          set -euxo pipefail
          if [ "${{ matrix.pike-version }}" = "8.1116" ]; then
            PIKE_VERSION="8.0.1116"
          else
            PIKE_VERSION="8.0.1956"
          fi

          PIKE_PREFIX="$HOME/.cache/pike/${PIKE_VERSION}"
          PIKE_DISTDIR="$HOME/.cache/pike/distfiles"
          PIKE_ARCHIVE="$PIKE_DISTDIR/Pike-v${PIKE_VERSION}.tar.gz"
          PIKE_URL="https://pike.lysator.liu.se/pub/pike/all/${PIKE_VERSION}/Pike-v${PIKE_VERSION}.tar.gz"

          if [ -x "$PIKE_PREFIX/bin/pike" ]; then
            echo "$PIKE_PREFIX/bin" >> "$GITHUB_PATH"
            exit 0
          fi

          mkdir -p "$PIKE_PREFIX" "$PIKE_DISTDIR"
          sudo apt-get update
          sudo apt-get install -y build-essential libgmp-dev nettle-dev nasm bison flex make wget

          download_pike_archive() {
            wget "$PIKE_URL" -O "$PIKE_ARCHIVE" || {
              echo "Pike ${PIKE_VERSION} source archive unavailable"
              exit 1
            }
          }

          if [ ! -f "$PIKE_ARCHIVE" ]; then
            download_pike_archive
          fi

          if ! tar -tzf "$PIKE_ARCHIVE" >/dev/null 2>&1; then
            rm -f "$PIKE_ARCHIVE"
            download_pike_archive
          fi

          if ! tar -tzf "$PIKE_ARCHIVE" >/dev/null 2>&1; then
            echo "Pike ${PIKE_VERSION} archive invalid after redownload"
            exit 1
          fi

          BUILD_DIR="/tmp/pike-${PIKE_VERSION}-build"
          rm -rf "$BUILD_DIR"
          mkdir -p "$BUILD_DIR"
          tar -xzf "$PIKE_ARCHIVE" -C "$BUILD_DIR" --strip-components=1
          cd "$BUILD_DIR/src"
          ./configure --prefix="$PIKE_PREFIX"
          make -j1
          make install
          echo "$PIKE_PREFIX/bin" >> "$GITHUB_PATH"

      - name: Verify Pike installation
        run: |
          pike --version
          which pike

      - name: Run Cross-Version Handler Tests
        run: pike test/tests/cross-version-tests.pike

      - name: Run Pike Tests
        run: ./scripts/run-pike-tests.sh

      - name: Cross-version test summary
        if: always()
        run: |
          echo "### Cross-version handler tests : ${{ matrix.pike-version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Pike version**: ${{ matrix.pike-version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: Cross-version tests verify all 12 LSP handlers work correctly" >> $GITHUB_STEP_SUMMARY
          echo "- **Test file**: test/tests/cross-version-tests.pike" >> $GITHUB_STEP_SUMMARY

  build-extension:
    runs-on: ubuntu-24.04
    needs: [test, pike-test]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache bun dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: bun-${{ runner.os }}-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            bun-${{ runner.os }}-

      - name: Install Pike
        run: |
          sudo apt-get update
          sudo apt-get install -y pike8.0

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build all packages
        run: bun run build

      - name: Build VSIX
        working-directory: packages/vscode-pike
        run: bun run package

      - name: Upload VSIX artifact
        uses: actions/upload-artifact@v4
        with:
          name: vscode-pike-extension-${{ github.sha }}
          path: packages/vscode-pike/vscode-pike-*.vsix
          retention-days: 30
          if-no-files-found: error

  vscode-e2e:
    runs-on: ubuntu-24.04
    needs: [test, pike-test]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache bun dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: bun-${{ runner.os }}-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            bun-${{ runner.os }}-

      - name: Cache apt packages
        uses: actions/cache@v4
        with:
          path: /var/cache/apt/archives/*.deb
          key: apt-${{ runner.os }}-vscode-e2e
          restore-keys: |
            apt-${{ runner.os }}-

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb pike8.0

      - name: Install dependencies
        run: bun install

      - name: Build all packages
        run: bun run build

      - name: Bundle LSP server
        run: cd packages/vscode-pike && bun run bundle-server

      - name: Build VSCode extension tests
        run: cd packages/vscode-pike && bun run build:test

      - name: Run VSCode unit tests
        working-directory: packages/vscode-pike
        run: bun test src/test/mockOutputChannel.test.ts

      - name: Run VSCode E2E Tests (full suite)
        working-directory: packages/vscode-pike
        run: bun run test:e2e

      - name: LSP Feature Test Summary
        if: always()
        run: |
          echo "### LSP Feature Tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The LSP feature tests verify:" >> $GITHUB_STEP_SUMMARY
          echo "- Document symbols (outline view)" >> $GITHUB_STEP_SUMMARY
          echo "- Hover (type information)" >> $GITHUB_STEP_SUMMARY
          echo "- Go-to-definition (navigation)" >> $GITHUB_STEP_SUMMARY
          echo "- Completion (autocomplete)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the 'Run VSCode LSP Feature Tests' step above for results." >> $GITHUB_STEP_SUMMARY
