name: Enforce acceptance criteria

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  check-acceptance-criteria:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
    steps:
      - name: Check acceptance criteria
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // Get PR body
            const body = pr.body || '';

            // Look for Acceptance Criteria OR Test plan section
            const acSection = body.match(/##\s*(Acceptance Criteria|Test plan)\s*([\s\S]*?)(?=##\s*|$)/i);

            if (!acSection) {
              // No acceptance criteria section - add needs-acceptance-criteria label
              await github.rest.issues.addLabels({
                owner,
                repo,
                issue_number: pr.number,
                labels: ['needs-acceptance-criteria']
              });
              console.log(`PR #${pr.number}: No acceptance criteria found, added 'needs-acceptance-criteria' label`);
              process.exit(1);
            }

            const acContent = acSection[2];

            // Check for unchecked boxes: - [ ]
            const uncheckedMatch = acContent.match(/- \[\s+\]/g);
            const uncheckedCount = uncheckedMatch ? uncheckedMatch.length : 0;

            if (uncheckedCount > 0) {
              // Has unchecked criteria - add needs-acceptance-criteria label
              await github.rest.issues.addLabels({
                owner,
                repo,
                issue_number: pr.number,
                labels: ['needs-acceptance-criteria']
              });
              console.log(`PR #${pr.number}: ${uncheckedCount} unchecked acceptance criteria, added 'needs-acceptance-criteria' label`);
              process.exit(1);
            }

            // All checked - remove needs-acceptance-criteria if present
            try {
              await github.rest.issues.removeLabel({
                owner,
                repo,
                issue_number: pr.number,
                name: 'needs-acceptance-criteria'
              });
              console.log(`PR #${pr.number}: All acceptance criteria checked, removed 'needs-acceptance-criteria' label`);
            } catch (e) {
              // Label might not exist, ignore
            }

            console.log(`PR #${pr.number}: All acceptance criteria met`);
