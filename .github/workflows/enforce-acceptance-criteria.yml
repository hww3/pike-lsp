name: Enforce PR format

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  check-pr-format:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
    steps:
      - name: Check PR format
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const body = pr.body || '';

            const addLabel = async () => {
              try {
                await github.rest.issues.addLabels({
                  owner, repo,
                  issue_number: pr.number,
                  labels: ['needs-acceptance-criteria']
                });
              } catch (e) {}
            };

            const removeLabel = async () => {
              try {
                await github.rest.issues.removeLabel({
                  owner, repo,
                  issue_number: pr.number,
                  name: 'needs-acceptance-criteria'
                });
              } catch (e) {}
            };

            const errors = [];

            // Must have non-empty Summary section
            const summaryMatch = body.match(
              /##\s*Summary\s*\n([\s\S]*?)(\n##\s|$)/i
            );
            const summaryContent = summaryMatch
              ? summaryMatch[1].replace(/<!--[\s\S]*?-->/g, '').trim()
              : '';

            if (!summaryContent) {
              errors.push(
                '- Missing or empty ## Summary section.\n' +
                '  Add: ## Summary\n' +
                '  <what this PR does â€” 1-2 sentences>'
              );
            }

            // Must have linked issue
            const hasLinkedIssue = /(closes|fixes|resolves)\s*#[0-9]+/i.test(body);
            if (!hasLinkedIssue) {
              errors.push(
                '- Missing linked issue.\n' +
                '  Add one of: Closes #N, Fixes #N, Resolves #N'
              );
            }

            if (errors.length > 0) {
              await addLabel();
              core.setFailed(
                `PR #${pr.number} is missing required fields:\n\n` +
                errors.join('\n\n') +
                '\n\nNote: CI jobs enforce that tests actually pass.'
              );
              return;
            }

            await removeLabel();
            console.log(`PR #${pr.number}: Format OK.`);
