name: Check Safe Label
on: [pull_request]

permissions:
  issues: read
  pull-requests: write
  contents: write

jobs:
  check-safe-label:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - name: Check safe label on linked issue
        run: |
          ISSUE=$(gh pr view ${{ github.event.pull_request.number }} \
            --repo ${{ github.repository }} \
            --json title,body --jq '(.title // "") + "\n" + (.body // "")' \
            | tr '[:upper:]' '[:lower:]' \
            | grep -oE '(closes|fixes|resolves) #[0-9]+' \
            | grep -oE '[0-9]+' \
            | head -1)

          if [ -z "$ISSUE" ]; then
            echo "ERROR: No linked issue found."
            echo "PR title/body must contain: 'closes #N', 'fixes #N', or 'resolves #N'"
            exit 1
          fi

          LABELS=$(gh issue view $ISSUE \
            --repo ${{ github.repository }} \
            --json labels --jq '.labels[].name')
          echo "Issue #$ISSUE labels: $LABELS"
          echo "$LABELS" | grep -q "^safe$" || \
            (echo "Issue #$ISSUE is missing the 'safe' label" && exit 1)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
