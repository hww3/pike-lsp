name: Close Linked Issue on Merge
on:
  pull_request:
    types: [closed]
    branches: [main]

permissions:
  issues: write
  pull-requests: read

jobs:
  close-issue:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-24.04
    steps:
      - name: Close linked issues
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const pr = context.payload.pull_request;
            const text = `${pr.title || ''}\n${pr.body || ''}`;
            const re = /\b(?:close[sd]?|fix(?:e[sd])?|resolve[sd]?)\s+#(\d+)\b/gi;

            const issueNumbers = new Set();
            let match;
            while ((match = re.exec(text)) !== null) {
              issueNumbers.add(Number(match[1]));
            }

            if (issueNumbers.size === 0) {
              core.info(`PR #${pr.number}: no linked issues found.`);
              return;
            }

            for (const issueNumber of issueNumbers) {
              const issue = await github.rest.issues.get({ owner, repo, issue_number: issueNumber });
              if (issue.data.state === 'closed') {
                core.info(`Issue #${issueNumber} already closed.`);
                continue;
              }

              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: issueNumber,
                body: `Closed automatically: PR #${pr.number} merged.`,
              });

              await github.rest.issues.update({
                owner,
                repo,
                issue_number: issueNumber,
                state: 'closed',
              });

              core.info(`Closed issue #${issueNumber}.`);
            }
